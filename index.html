
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Actor Simulator</title>
  <style>
  body {
  font-family: 'Poppins', sans-serif;
  background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #0a1d37 100%);
  padding: 0;
  margin: 0;
  color: #f0f4f8;
  min-height: 100vh;
  background-attachment: fixed;
  overflow-x: hidden;
  position: relative;
}

body::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='%231e3c72' fill-opacity='0.3' d='M0,64L48,80C96,96,192,128,288,128C384,128,480,96,576,85.3C672,75,768,85,864,90.7C960,96,1056,96,1152,85.3C1248,75,1344,53,1392,42.7L1440,32L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3E%3C/path%3E%3C/svg%3E") no-repeat center/cover;
  z-index: 0;
  animation: wave 10s ease-in-out infinite;
}

@keyframes wave {
  0% { transform: translateY(0); }
  50% { transform: translateY(-20px); }
  100% { transform: translateY(0); }
}

body::after {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: radial-gradient(circle, rgba(255,255,255,0.05) 1%, transparent 20%) repeat;
  z-index: 1;
}

#profileForm, #game {
  position: relative;
  z-index: 2;
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(5px);
  padding: 25px;
  max-width: 650px;
  margin: auto;
  box-shadow: 0 0 15px rgba(0,0,0,0.5);
  border-radius: 12px;
  color: #f0f4f8;
}

input, select, button {
  width: 100%;
  padding: 12px;
  margin: 10px 0;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 16px;
}

button {
  background: linear-gradient(45deg, #007bff, #00c4ff);
  color: #fff;
  cursor: pointer;
  border: none;
  box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
  transition: all 0.3s ease;
}

button:hover {
  background: linear-gradient(45deg, #0056b3, #0096cc);
  box-shadow: 0 6px 15px rgba(0, 123, 255, 0.5);
  transform: translateY(-2px);
}

#stats {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  grid-template-rows: auto auto auto;
  gap: 6px;
  margin-top: 5px;
  margin-bottom: 10px;
  max-width: 100%;
  padding: 0 10px;
}

.stat-card {
  background: linear-gradient(145deg, #ffffff, #e6e6e6);
  border-radius: 12px;
  text-align: center;
  padding: 12px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  height: 80px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  position: relative;
  overflow: hidden;
}

.stat-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25);
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 4px;
  background: linear-gradient(90deg, #ffd700, #ff4d4d);
  opacity: 0.7;
}

.stat-icon {
  font-size: 20px;
  margin-bottom: 6px;
  padding: 8px;
  background: #007bff;
  color: #fff;
  border-radius: 50%;
  transition: transform 0.3s ease;
}

.stat-card:hover .stat-icon {
  transform: scale(1.1);
}

.stat-label {
  font-size: 12px;
  color: #1a1a1a;
  font-weight: 500;
  display: block;
  word-wrap: break-word;
  white-space: normal;
  margin: 0;
}

.stat-label span {
  font-size: 16px;
  font-weight: 700;
  color: #007bff;
}

.stat-progress {
  width: 80%;
  height: 6px;
  background: #e0e0e0;
  border-radius: 3px;
  margin-top: 5px;
}

.stat-progress-bar {
  height: 100%;
  background: linear-gradient(90deg, #007bff, #00c4ff);
  border-radius: 3px;
  transition: width 0.5s ease;
}

#stats .stat-card:nth-child(1) { grid-column: 1; grid-row: 1; }
#stats .stat-card:nth-child(2) { grid-column: 2; grid-row: 1; }
#stats .stat-card:nth-child(3) { grid-column: 3; grid-row: 1; }
#stats .stat-card:nth-child(4) { grid-column: 4; grid-row: 1; }
#stats .stat-card:nth-child(5) { grid-column: 1; grid-row: 2; }
#stats .stat-card:nth-child(6) { grid-column: 2; grid-row: 2; }
#stats .stat-card:nth-child(7) { grid-column: 3; grid-row: 2; }
#stats .stat-card:nth-child(8) { grid-column: 4; grid-row: 2; }
#stats .stat-card:nth-child(9) { grid-column: 2 / 4; grid-row: 3; }

@media (max-width: 600px) {
  #stats {
    grid-template-columns: repeat(2, 1fr);
    grid-template-rows: auto auto auto auto auto;
    gap: 6px;
    padding: 0 8px;
  }
  #stats .stat-card:nth-child(1) { grid-column: 1; grid-row: 1; }
  #stats .stat-card:nth-child(2) { grid-column: 2; grid-row: 1; }
  #stats .stat-card:nth-child(3) { grid-column: 1; grid-row: 2; }
  #stats .stat-card:nth-child(4) { grid-column: 2; grid-row: 2; }
  #stats .stat-card:nth-child(5) { grid-column: 1; grid-row: 3; }
  #stats .stat-card:nth-child(6) { grid-column: 2; grid-row: 3; }
  #stats .stat-card:nth-child(7) { grid-column: 1; grid-row: 4; }
  #stats .stat-card:nth-child(8) { grid-column: 2; grid-row: 4; }
  #stats .stat-card:nth-child(9) { grid-column: 1 / 3; grid-row: 5; }
  .stat-card {
    height: 70px;
    padding: 8px;
  }
  .stat-icon {
    font-size: 16px;
    padding: 6px;
  }
  .stat-label {
    font-size: 10px;
  }
  .stat-label span {
    font-size: 12px;
  }
}

#weekChoices {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 8px;
  margin-top: 10px;
}

.choice-btn {
  background: linear-gradient(45deg, #28a745, #34c759);
  color: #fff;
  font-weight: 600;
  padding: 12px;
  font-size: 16px;
  border-radius: 10px;
  border: none;
  width: 100%;
  box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
  text-align: center;
}

.choice-btn:hover {
  background: linear-gradient(45deg, #1e7e34, #2ea44f);
  box-shadow: 0 6px 15px rgba(0, 123, 255, 0.5);
  transform: translateY(-2px);
}

.choice-btn::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 50%;
  transform: translate(-50%, -50%);
  transition: width 0.4s ease, height 0.4s ease;
}

.choice-btn:hover::after {
  width: 200%;
  height: 200%;
}

.choice-btn:disabled {
  background: #cccccc;
  cursor: not-allowed;
  box-shadow: none;
}

@media (max-width: 600px) {
  #weekChoices {
    grid-template-columns: 1fr;
    gap: 6px;
  }
  .choice-btn {
    padding: 10px;
    font-size: 14px;
  }
}

#log {
  margin-top: 20px;
  padding: 15px;
  background: #fffbea;
  border: 1px dashed #999;
  border-radius: 8px;
}

#topButtons {
  display: flex;
  justify-content: space-between;
  margin-bottom: 10px;
}

#nextWeekContainer {
  margin-top: 10px;
}

#nextWeekBtn {
  background: linear-gradient(45deg, #ffc107, #ffca2c);
  color: #333;
  font-weight: 600;
  width: 100%;
  padding: 12px;
  border-radius: 10px;
  border: none;
  font-size: 16px;
  cursor: pointer;
  box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

#nextWeekBtn:hover {
  background: linear-gradient(45deg, #e0a800, #ffca2c);
  box-shadow: 0 6px 15px rgba(0, 123, 255, 0.5);
  transform: translateY(-2px);
}

#nextWeekBtn::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 50%;
  transform: translate(-50%, -50%);
  transition: width 0.4s ease, height 0.4s ease;
}

#nextWeekBtn:hover::after {
  width: 200%;
  height: 200%;
}

#modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  justify-content: center;
  align-items: center;
  z-index: 1000;
  animation: fadeIn 0.3s ease;
}

.modal-content {
  background: #ffffff;
  padding: 25px;
  border-radius: 16px;
  max-width: 550px;
  width: 90%;
  text-align: center;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
  border: 2px solid #007bff;
  transform: scale(0.8);
  animation: popIn 0.3s ease forwards;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes popIn {
  from { transform: scale(0.8); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

.modal-content p {
  font-size: 18px;
  line-height: 1.5;
  color: #333;
  margin: 0 0 20px;
  white-space: pre-wrap;
}

.modal-content h3 {
  font-size: 22px;
  color: #1e3c72;
  margin: 0 0 15px;
  font-weight: 600;
}

.modal-buttons {
  display: flex;
  justify-content: space-around;
  margin-top: 20px;
  gap: 10px;
}

.modal-ok-button {
  display: none;
  margin-top: 20px;
}

.modal-btn {
  width: 45%;
  padding: 12px;
  border-radius: 10px;
  cursor: pointer;
  font-size: 16px;
  font-weight: 600;
  transition: all 0.3s ease;
}

.modal-btn.yes {
  background: linear-gradient(45deg, #28a745, #34c759);
  color: #fff;
}

.modal-btn.yes:hover {
  background: linear-gradient(45deg, #1e7e34, #2ea44f);
}

.modal-btn.no {
  background: linear-gradient(45deg, #dc3545, #ff4d4d);
  color: #fff;
}

.modal-btn.no:hover {
  background: linear-gradient(45deg, #c82333, #e02d3d);
}

.modal-btn.ok {
  background: linear-gradient(45deg, #007bff, #00c4ff);
  color: #fff;
  width: 100%;
}

.modal-btn.ok:hover {
  background: linear-gradient(45deg, #0056b3, #0096cc);
}

.modal-buttons.info {
  display: none;
}

.modal-ok-button.info {
  display: block;
}

#lifestyleChoices {
  margin-top: 20px;
}

#saveNotification {
  display: none;
  position: fixed;
  top: 20px;
  right: 20px;
  background: linear-gradient(45deg, #28a745, #34c759);
  color: #fff;
  padding: 12px 24px;
  border-radius: 10px;
  z-index: 1001;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
  gap: 10px;
  margin-top: 10px;
  margin-bottom: 15px;
  max-width: 100%;
}

.genre-checkbox {
  margin-right: 10px;
  vertical-align: middle;
  transform: scale(1.5);
}

.modal-content label {
  display: block;
  font-size: 16px;
  color: #333;
  margin: 8px 0;
  text-align: left;
  padding: 5px;
}

.modal-content input[type="checkbox"] {
  width: auto;
  margin-right: 8px;
}

.modal-content.short-film {
  max-width: 350px;
  padding: 15px;
}

.modal-content.short-film h3 {
  font-size: 18px;
  margin: 0 0 10px;
}

.modal-content.short-film p {
  font-size: 14px;
  margin: 0 0 10px;
}

.modal-content.short-film input[type="text"],
.modal-content.short-film input[type="number"] {
  padding: 6px;
  font-size: 14px;
  margin: 5px 0;
}

.modal-content.short-film .genre-checkbox {
  transform: scale(1.2);
  margin-right: 6px;
}

.modal-content.short-film label {
  font-size: 14px;
  margin: 5px 0;
  padding: 3px;
  background: none;
}

.modal-content.short-film .modal-buttons {
  margin-top: 10px;
  gap: 5px;
}

.modal-content.short-film .modal-btn {
  padding: 8px;
  font-size: 14px;
}
</style>
</head>
<body>

  <div id="profileForm" style="display:none;">
    <h2>Create Your Actor Profile</h2>
    <input type="text" id="fullName" placeholder="Full Name">
    <input type="text" id="stageName" placeholder="Stage Name">
    <input type="number" id="age" placeholder="Age (17-60)" min="17" max="60">
    <input type="text" id="city" placeholder="City">
    <label>Starting Date:</label>
    <input type="date" id="startDate" min="2025-01-01" max="2028-12-31">
    <label>Choose Currency:</label>
    <select id="currency">
      <option value="$">$ Dollar</option>
      <option value="€">€ Euro</option>
      <option value="£">£ Pound</option>
    </select>
    <button onclick="startGame()">Start My Acting Career</button>
  </div>

  <div id="game" style="display:none;">
  <div id="topButtons">
    <button onclick="saveGame()">Save</button>
    <button onclick="resetGame()">Reset</button>
  </div>
  <div id="nextWeekContainer">
    <button id="nextWeekBtn" onclick="nextWeek()"> Next Week</button>
  </div>

  <div id="saveNotification">Game Saved!</div>

  <h2> Welcome, <span id="nameDisplay"></span></h2>
  <p><strong>From:</strong> <span id="cityDisplay"></span></p>
  <p><strong>Age:</strong> <span id="ageDisplay"></span></p>
  <p><strong>Started:</strong> <span id="startDateDisplay"></span></p>

  <div id="stats" class="stats-grid">
  <div class="stat-card">
    <div class="stat-icon"></div>
    <span class="stat-label">Fame <span id="fame">1</span>/100</span>
  </div>
  <div class="stat-card">
    <div class="stat-icon">📱</div>
    <span class="stat-label">Followers <span id="followers">10</span></span>
  </div>
  <div class="stat-card">
    <div class="stat-icon">💰</div>
    <span class="stat-label">Money <span id="currencySymbol">$</span><span id="money">500</span></span>
  </div>
  <div class="stat-card">
    <div class="stat-icon">🎬</div>
    <span class="stat-label">Blockbusters <span id="blockbusters">0</span></span>
  </div>
  <div class="stat-card">
    <div class="stat-icon">📜</div>
    <span class="stat-label">Scripts <span id="scripts">0</span></span>
  </div>
  <div class="stat-card">
    <div class="stat-icon">🎭</div>
    <span class="stat-label">Skill <span id="skill">Beginner</span></span>
  </div>
  <div class="stat-card">
    <div class="stat-icon">⚡</div>
    <span class="stat-label">Energy <span id="energy">100</span>/100</span>
  </div>
  <div class="stat-card">
    <div class="stat-icon">💍</div>
    <span class="stat-label">Status <span id="marriageStatus">Single</span></span>
  </div>
  <div class="stat-card">
    <div class="stat-icon">📅</div>
    <span class="stat-label">Year & Week <span id="weekNum">Year 1, Week 1</span></span>
  </div>
</div>

  <h3>🎯 This Week – Choose your actions:</h3>
  <div id="weekChoices">
    <button class="choice-btn" onclick="chooseAction(1, 50)">🎤 Audition ($3,000) -50⚡</button>
    <button class="choice-btn" onclick="chooseAction(2, 15)">📲 Post TikTok -10⚡</button>
    <button class="choice-btn" onclick="chooseAction(3, 30)">🎓 Attend Workshop -30⚡</button>
    <button class="choice-btn" onclick="practice()">🧘 Practice Acting -30⚡</button>
    <button class="choice-btn" onclick="chooseAction(4, 20)">🤝 Hire Talent Agent ($2,000) -20⚡</button>
    <button class="choice-btn" onclick="chooseAction(5, 30)">💼 Take a Side Job -50⚡</button>
    <button class="choice-btn" id="blockbusterBtn" onclick="chooseAction(6, 40)">🎬 Hire for Blockbuster Movie -60⚡</button>
    <button class="choice-btn" id="writeScriptBtn" onclick="writeScript()">✍️ Write Script -50⚡</button>
    <button class="choice-btn" id="sellScriptBtn" onclick="sellScript()">💸 Sell Script -30⚡</button>
    <button class="choice-btn" id="aListPartyBtn" onclick="attendAListParty()">🥂 Attend A-List Party ($2,500) -25⚡</button>
    <button class="choice-btn" id="voiceActBtn" onclick="voiceActVideoGame()">🎮 Voice Act in Video Game -30⚡</button>
    <button class="choice-btn" id="endorsementBtn" onclick="doBrandEndorsement()">📺 Do Brand Endorsement Deal ($1,000) -20⚡</button>
    <button class="choice-btn" id="networkingBtn" onclick="attendNetworkingEvent()">🤝 Attend Industry Networking Event ($2,000) -25⚡</button>
    <button class="choice-btn" id="merchLineBtn" onclick="launchMerchLine()">🛍️ Launch Merchandise Line ($15,000) -40⚡</button>
    <button class="choice-btn" id="produceMovieBtn" onclick="produceMovie()">🎥 Produce Movie ($10,000) -50⚡</button>
    <button class="choice-btn" id="shortFilmBtn" onclick="writeShortFilm()">🎥 Release Short Film on TikTok -30⚡</button>
    <button class="choice-btn" id="scheduleVideoBtn" onclick="scheduleVideoRelease()">📅 Schedule Video Release -20⚡</button>
  </div>

  <h3>🛍️ Lifestyle Purchases</h3>
  <div id="lifestyleChoices">
    <!-- Lifestyle buttons will be dynamically generated -->
  </div>

  <div id="log"></div>
</div>

  <!-- Modal for Notifications -->
  <div id="modal">
    <div class="modal-content">
      <p id="modalMessage"></p>
      <div id="modalButtons" class="modal-buttons">
        <button class="modal-btn yes" onclick="resolveModal(true)">Yes</button>
        <button class="modal-btn no" onclick="resolveModal(false)">No</button>
      </div>
      <div id="modalOkButton" class="modal-ok-button">
        <button class="modal-btn ok" onclick="resolveModal(true)">OK</button>
      </div>
    </div>
  </div>

  <script>
    let money;
let fame = 1;
let followers = 10;
let skill = "Beginner";
let week = 1;
let year = 1; // New variable to track the current year
let energy = 100;
let currencySymbol = "$";
let practiceXP = 0;
let startDate = "";
let age = 17;
let hasAgent = false;
let blockbusters = 0;
let scripts = 0;
let scriptQualities = [];
let voiceActingIncome = 0;
let voiceActingWeeks = 0;
let merchIncome = 0;
let merchWeeks = 0;
let merchFailed = false; // Track if merch line has failed
let purchasedItems = [];
let isTikTokMonetized = false;
let tiktokIncome = 0;
let tiktokMonetizationWeeks = 0;
let isMarried = false;
let spouseName = "";
let producedMovies = 0;
let scheduledShortFilms = []; // Array to store scheduled short films
let videoLibrary = []; // Array to store all videos (short films, sequels, series episodes)
let movieRoyaltyWeeks = 0; // Tracks remaining weeks for movie royalty payments
// New variables for cooldowns and availability
let actionCooldowns = {
  writeScript: 0,       // Weeks until Write Script is available again
  blockbuster: 0,       // Weeks until Hire for Blockbuster Movie is available
  aListParty: 0,        // Weeks until Attend A-List Party is available
  voiceAct: 0,          // Weeks until Voice Act in Video Game is available
  endorsement: 0,       // Weeks until Do Brand Endorsement Deal is available
  networking: 0,        // Weeks until Attend Industry Networking Event is available
  merchLine: 0,         // Weeks until Launch Merchandise Line is available
  produceMovie: 0       // Weeks until Produce Movie is available
};
let actionAvailability = {
  writeScript: true,    // Always available initially, but limited by cooldown
  blockbuster: false,
  aListParty: false,
  voiceAct: false,
  endorsement: false,
  networking: false,
  merchLine: false,
  produceMovie: true
};
let actionUses = {
  audition: 0,         // Track Audition uses
  tiktok: 0,          // Track Post TikTok uses
  workshop: 0,        // Track Attend Workshop uses
  practice: 0,        // Track Practice Acting uses
  sideJob: 0,         // Track Take a Side Job uses
  writeScript: 0,
  blockbuster: 0,
  aListParty: 0,
  voiceAct: 0,
  endorsement: 0,
  networking: 0,
  merchLine: 0,
  produceMovie: 0
};
const genres = [
  { name: "Drama", minXP: 7, qualityMultiplier: 1.0 },
  { name: "Comedy", minXP: 7, qualityMultiplier: 0.9 },
  { name: "Action", minXP: 10, qualityMultiplier: 1.2 },
  { name: "Romance", minXP: 10, qualityMultiplier: 1.0 },
  { name: "Sci-Fi", minXP: 15, qualityMultiplier: 1.3 },
  { name: "Horror", minXP: 15, qualityMultiplier: 1.1 },
  { name: "Thriller", minXP: 20, qualityMultiplier: 1.2 },
  { name: "Fantasy", minXP: 35, qualityMultiplier: 1.3 },
  { name: "Documentary", minXP: 50, qualityMultiplier: 1.1 }
];
const MAX_ACTION_USES_PER_YEAR = {
  writeScript: 2,       // Max 2 scripts per year
  blockbuster: 1,       // Max 1 blockbuster role per year
  aListParty: 3,        // Max 3 parties per year
  voiceAct: 2,          // Max 2 voice acting gigs per year
  endorsement: 3,       // Max 3 endorsements per year
  networking: 3,        // Max 3 networking events per year
  merchLine: 1,         // Max 1 merch line launch per year
  produceMovie: 2       // Max 2 movie productions per year
};
let modalResolve;
const SAVE_VERSION = "1.2";

    const lifestyleItems = [
      { name: "Designer Clothes", price: 20000, fameReward: 0.2 },
      { name: "Gold Necklace", price: 50000, fameReward: 0.3 },
      { name: "Sports Car", price: 100000, fameReward: 0.4 },
      { name: "Luxury Watch", price: 250000, fameReward: 0.5 },
      { name: "Penthouse Apartment", price: 1000000, fameReward: 0.6 },
      { name: "Luxury Boutique", price: 5000000, fameReward: 0.7 },
      { name: "Mansion", price: 10000000, fameReward: 0.8 },
      { name: "Yacht", price: 50000000, fameReward: 0.9 },
      { name: "Customized Private Jet", price: 1000000000, fameReward: 1 }
    ];

    function getStartingMoney(currency) {
      switch (currency) {
        case "$": return 500;
        case "€": return 425;
        case "£": return 375;
        default: return 500;
      }
    }

    function convertCurrency(amount) {
      switch (currencySymbol) {
        case "€": return Math.round(amount * 0.85);
        case "£": return Math.round(amount * 0.75);
        default: return amount;
      }
    }

function formatMoney(amount) {
  const absAmount = Math.abs(amount);
  let formatted = "";
  let suffix = "";

  if (absAmount >= 1_000_000_000) {
    formatted = (amount / 1_000_000_000).toFixed(1).replace(/\.0$/, "");
    suffix = "b";
  } else if (absAmount >= 1_000_000) {
    formatted = (amount / 1_000_000).toFixed(1).replace(/\.0$/, "");
    suffix = "m";
  } else if (absAmount >= 1_000) {
    formatted = (amount / 1_000).toFixed(1).replace(/\.0$/, "");
    suffix = "k";
  } else {
    formatted = amount.toString();
  }

  return `${amount < 0 ? '-' : ''}${currencySymbol}${formatted}${suffix}`;
}

    function getSkillByXP(xp) {
      if (xp >= 100) return "Master";
      if (xp >= 70) return "Expert";
      if (xp >= 50) return "Pro";
      if (xp >= 30) return "Trained";
      if (xp >= 20) return "Improving";
      if (xp >= 10) return "Learning";
      if (xp >= 4) return "Novice";
      return "Beginner";
    }

    function showModal(message, type = "choice") {
  return new Promise((resolve) => {
    const modalContent = document.querySelector(".modal-content");
    modalContent.innerHTML = `
      <h3>${type === "info" ? "Game Update" : "Decision"}</h3>
      <p>${message.replace(/\n/g, "<br>")}</p>
      <div id="modalButtons" class="modal-buttons${type === "info" ? " info" : ""}">
        <button class="modal-btn yes" onclick="resolveModal(true)">Yes</button>
        <button class="modal-btn no" onclick="resolveModal(false)">No</button>
      </div>
      <div id="modalOkButton" class="modal-ok-button${type === "info" ? " info" : ""}">
        <button class="modal-btn ok" onclick="resolveModal(true)">OK</button>
      </div>
    `;
    document.getElementById("modal").style.display = "flex";
    modalResolve = resolve;
  });
}

function showInfoModal(message) {
  return showModal(message, "info");
}

    function resolveModal(choice) {
      document.getElementById("modal").style.display = "none";
      modalResolve(choice);
    }

    function showSaveNotification() {
      const notification = document.getElementById("saveNotification");
      notification.style.display = "block";
      setTimeout(() => {
        notification.style.display = "none";
      }, 2000);
    }

    function saveGame() {
  const data = {
    version: SAVE_VERSION,
    money,
    fame,
    followers,
    skill,
    week,
    year,
    energy,
    currencySymbol,
    practiceXP,
    startDate,
    age,
    hasAgent,
    blockbusters,
    scripts,
    scriptQualities,
    voiceActingIncome,
    voiceActingWeeks,
    merchIncome,
    merchWeeks,
    merchFailed,
    purchasedItems,
    isTikTokMonetized,
    tiktokIncome,
    tiktokMonetizationWeeks,
    isMarried,
    spouseName,
    actionCooldowns,
    actionAvailability,
    actionUses,
    producedMovies,
    movieRoyaltyWeeks,
    scheduledShortFilms,
    videoLibrary, // Add new variable
    fullName: document.getElementById("nameDisplay").textContent.split(" (")[1]?.replace(")", "") || "",
    stageName: document.getElementById("nameDisplay").textContent.split(" (")[0] || "",
    city: document.getElementById("cityDisplay").textContent || ""
  };
  setTimeout(() => {
    try {
      localStorage.setItem("actorSimSave", JSON.stringify(data));
      showSaveNotification();
    } catch (e) {
      console.error("Save failed:", e);
      showModal("Failed to save game. Try again?");
    }
  }, 0);
}

    function loadGame() {
  const savedData = localStorage.getItem("actorSimSave");
  if (!savedData) {
    console.log("No saved game found, starting fresh.");
    document.getElementById("profileForm").style.display = "block";
    document.getElementById("game").style.display = "none";
    return false;
  }

  try {
    const data = JSON.parse(savedData);
    if (data.version !== SAVE_VERSION) {
      console.warn(`Save version mismatch: expected ${SAVE_VERSION}, got ${data.version}. Starting fresh.`);
      localStorage.removeItem("actorSimSave");
      document.getElementById("profileForm").style.display = "block";
      document.getElementById("game").style.display = "none";
      return false;
    }

    money = Number(data.money) || getStartingMoney(data.currencySymbol || "$");
    fame = Number(data.fame) || Number(data.reputation) || 1;
    followers = Number(data.followers) || 10;
    skill = data.skill || "Beginner";
    week = Number(data.week) || 1;
    year = Number(data.year) || 1;
    energy = Number(data.energy) || 100;
    currencySymbol = data.currencySymbol || "$";
    practiceXP = Number(data.practiceXP) || 0;
    startDate = data.startDate || "";
    age = Number(data.age) || 17;
    hasAgent = data.hasAgent || false;
    blockbusters = Number(data.blockbusters) || 0;
    scripts = Number(data.scripts) || 0;
    scriptQualities = Array.isArray(data.scriptQualities)
      ? data.scriptQualities.map(s => ({
          quality: s.quality || "Standard",
          genres: Array.isArray(s.genres) ? s.genres : []
        }))
      : [];
    voiceActingIncome = Number(data.voiceActingIncome) || 0;
    voiceActingWeeks = Number(data.voiceActingWeeks) || 0;
    merchIncome = Number(data.merchIncome) || 0;
    merchWeeks = Number(data.merchWeeks) || 0;
    merchFailed = data.merchFailed || false;
    purchasedItems = Array.isArray(data.purchasedItems) ? data.purchasedItems : [];
    isTikTokMonetized = data.isTikTokMonetized || false;
    tiktokIncome = Number(data.tiktokIncome) || 0;
    tiktokMonetizationWeeks = Number(data.tiktokMonetizationWeeks) || 0;
    isMarried = data.isMarried || false;
    spouseName = data.spouseName || "";
    producedMovies = Number(data.producedMovies) || 0;
    movieRoyaltyWeeks = Number(data.movieRoyaltyWeeks) || 0;
    scheduledShortFilms = Array.isArray(data.scheduledShortFilms)
      ? data.scheduledShortFilms.map(f => ({
          title: f.title || "Untitled",
          duration: Number(f.duration) || 1,
          genres: Array.isArray(f.genres) ? f.genres : [],
          quality: f.quality || "Standard",
          releaseWeek: Number(f.releaseWeek) || 1,
          releaseYear: Number(f.releaseYear) || 1
        }))
      : [];
    videoLibrary = Array.isArray(data.videoLibrary)
      ? data.videoLibrary.map(v => ({
          title: v.title || "Untitled",
          type: v.type || "Short Film",
          seriesTitle: v.seriesTitle || "",
          episodeNumber: Number(v.episodeNumber) || 0,
          genres: Array.isArray(v.genres) ? v.genres : [],
          quality: v.quality || "Standard",
          duration: Number(v.duration) || 1,
          releaseWeek: Number(v.releaseWeek) || 0,
          releaseYear: Number(v.releaseYear) || 0,
          isReleased: v.isReleased || false,
          originalFilmIndex: Number(v.originalFilmIndex) || -1
        }))
      : [];
    actionCooldowns = data.actionCooldowns || {
      writeScript: 0,
      blockbuster: 0,
      aListParty: 0,
      voiceAct: 0,
      endorsement: 0,
      networking: 0,
      merchLine: 0,
      produceMovie: 0
    };
    actionAvailability = data.actionAvailability || {
      writeScript: true,
      blockbuster: false,
      aListParty: false,
      voiceAct: false,
      endorsement: false,
      networking: false,
      merchLine: false,
      produceMovie: true
    };
    actionUses = data.actionUses || {
      writeScript: 0,
      blockbuster: 0,
      aListParty: 0,
      voiceAct: 0,
      endorsement: 0,
      networking: 0,
      merchLine: 0,
      produceMovie: 0
    };

    skill = getSkillByXP(practiceXP);
    document.getElementById("currencySymbol").textContent = currencySymbol;
    document.getElementById("weekNum").textContent = `Year ${year}, Week ${week}`;
    document.getElementById("startDateDisplay").textContent = startDate;
    document.getElementById("ageDisplay").textContent = age;
    document.getElementById("nameDisplay").textContent = data.stageName ? `${data.stageName} (${data.fullName || ''})` : "Unknown Actor";
    document.getElementById("cityDisplay").textContent = data.city || "Unknown City";
    document.getElementById("profileForm").style.display = "none";
    document.getElementById("game").style.display = "block";

    updateStats();
    updateLifestyleButtons();
    checkEnergy();

    console.log("Game loaded successfully.");
    return true;
  } catch (e) {
    console.error("Load failed:", e);
    localStorage.removeItem("actorSimSave");
    document.getElementById("profileForm").style.display = "block";
    document.getElementById("game").style.display = "none";
    showInfoModal("Failed to load saved game due to an error. Starting fresh.");
    return false;
  }
}

    function updateLifestyleButtons() {
  const lifestyleChoices = document.getElementById("lifestyleChoices");
  lifestyleChoices.innerHTML = "";
  lifestyleItems.forEach((item, index) => {
    const convertedPrice = convertCurrency(item.price);
    const isPurchased = purchasedItems.includes(index);
    const button = document.createElement("button");
    button.className = "choice-btn";
    button.textContent = isPurchased
      ? `🛍️ ${item.name} (Owned)`
      : `🛍️ Buy ${item.name} (${currencySymbol}${convertedPrice}, +${item.fameReward} Fame)`;
    button.disabled = isPurchased || money < convertedPrice;
    button.onclick = () => buyLifestyleItem(index);
    lifestyleChoices.appendChild(button);
  });

  // Add Get Married button
  const marriageButton = document.createElement("button");
  marriageButton.className = "choice-btn";
  marriageButton.textContent = isMarried
    ? `💍 Married to ${spouseName}`
    : `💍 Get Married (${currencySymbol}10,000, +0.5 Fame, +100 Followers)`;
  marriageButton.disabled = isMarried || age < 20 || money < convertCurrency(10000) || fame < 20 || energy < 30;
  marriageButton.onclick = getMarried;
  lifestyleChoices.appendChild(marriageButton);
}

    function updateWeekChoices() {
  const buttons = {
  writeScript: document.getElementById("writeScriptBtn"),
  blockbuster: document.getElementById("blockbusterBtn"),
  aListParty: document.getElementById("aListPartyBtn"),
  voiceAct: document.getElementById("voiceActBtn"),
  endorsement: document.getElementById("endorsementBtn"),
  networking: document.getElementById("networkingBtn"),
  merchLine: document.getElementById("merchLineBtn"),
  produceMovie: document.getElementById("produceMovieBtn"),
  shortFilm: document.getElementById("shortFilmBtn") // Add new button
};

  // Handle audition button
  const auditionBtn = document.querySelector('.choice-btn[onclick="chooseAction(1, 50)"]');
  if (fame >= 50) {
    auditionBtn.textContent = `🎤 Audition (Too famous for minor roles)`;
    auditionBtn.disabled = true;
  } else {
    auditionBtn.textContent = `🎤 Audition (${currencySymbol}${formatMoney(1000)}) -50⚡`;
    auditionBtn.disabled = money < convertCurrency(1000) || energy < 50;
  }

  // Handle workshop button
  const workshopBtn = document.querySelector('.choice-btn[onclick="chooseAction(3, 30)"]');
  workshopBtn.textContent = `🎓 Attend Workshop -30⚡`;
  workshopBtn.disabled = energy < 30 || practiceXP >= 100;

  // Handle hire agent button
  const hireAgentBtn = document.querySelector('.choice-btn[onclick="chooseAction(4, 20)"]');
  hireAgentBtn.textContent = `🤝 Hire Talent Agent (${currencySymbol}${formatMoney(2000)}) -20⚡`;
  hireAgentBtn.disabled = energy < 20 || money < convertCurrency(2000) || hasAgent;

  // Handle side job button
  const sideJobBtn = document.querySelector('.choice-btn[onclick="chooseAction(5, 30)"]');
  sideJobBtn.textContent = `💼 Take a Side Job -30⚡`;
  sideJobBtn.disabled = energy < 30;

  // Update other action buttons (unchanged)
  buttons.writeScript.textContent = `✍️ Write Script -30⚡${actionCooldowns.writeScript > 0 ? ` (Available in ${actionCooldowns.writeScript} weeks)` : ""}${actionUses.writeScript >= MAX_ACTION_USES_PER_YEAR.writeScript ? " (Yearly limit reached)" : ""}`;
  buttons.writeScript.disabled = !actionAvailability.writeScript || energy < 30 || practiceXP < 7;

  buttons.blockbuster.textContent = `🎬 Hire for Blockbuster Movie -40⚡${actionCooldowns.blockbuster > 0 ? ` (Available in ${actionCooldowns.blockbuster} weeks)` : ""}${actionUses.blockbuster >= MAX_ACTION_USES_PER_YEAR.blockbuster ? " (Yearly limit reached)" : ""}`;
  buttons.blockbuster.disabled = !actionAvailability.blockbuster || energy < 40 || fame < 45;

  buttons.aListParty.textContent = `🥂 Attend A-List Party (${currencySymbol}${formatMoney(2500)}) -25⚡${actionCooldowns.aListParty > 0 ? ` (Available in ${actionCooldowns.aListParty} weeks)` : ""}${actionUses.aListParty >= MAX_ACTION_USES_PER_YEAR.aListParty ? " (Yearly limit reached)" : ""}`;
  buttons.aListParty.disabled = !actionAvailability.aListParty || energy < 25 || money < convertCurrency(2500) || fame < 20;

  buttons.voiceAct.textContent = `🎮 Voice Act in Video Game -30⚡${actionCooldowns.voiceAct > 0 ? ` (Available in ${actionCooldowns.voiceAct} weeks)` : ""}${actionUses.voiceAct >= MAX_ACTION_USES_PER_YEAR.voiceAct ? " (Yearly limit reached)" : ""}`;
  buttons.voiceAct.disabled = !actionAvailability.voiceAct || energy < 30 || fame < 15;

  buttons.endorsement.textContent = `📺 Do Brand Endorsement Deal (${currencySymbol}${formatMoney(1000)}) -20⚡${actionCooldowns.endorsement > 0 ? ` (Available in ${actionCooldowns.endorsement} weeks)` : ""}${actionUses.endorsement >= MAX_ACTION_USES_PER_YEAR.endorsement ? " (Yearly limit reached)" : ""}`;
  buttons.endorsement.disabled = !actionAvailability.endorsement || energy < 20 || money < convertCurrency(1000) || fame < 30;

  buttons.networking.textContent = `🤝 Attend Industry Networking Event (${currencySymbol}${formatMoney(2000)}) -25⚡${actionCooldowns.networking > 0 ? ` (Available in ${actionCooldowns.networking} weeks)` : ""}${actionUses.networking >= MAX_ACTION_USES_PER_YEAR.networking ? " (Yearly limit reached)" : ""}`;
  buttons.networking.disabled = !actionAvailability.networking || energy < 25 || money < convertCurrency(2000) || fame < 25 || practiceXP < 20;

  buttons.merchLine.textContent = `🛍️ Launch Merchandise Line (${currencySymbol}${formatMoney(15000)}) -40⚡${actionCooldowns.merchLine > 0 ? ` (Available in ${actionCooldowns.merchLine} weeks)` : ""}${actionUses.merchLine >= MAX_ACTION_USES_PER_YEAR.merchLine ? " (Yearly limit reached)" : ""}`;
  buttons.merchLine.disabled = !actionAvailability.merchLine || energy < 40 || money < convertCurrency(15000) || fame < 35 || followers < 500;

  const produceBaseCost = 10000;
  const produceExtraCost = fame >= 10 ? (fame - 10) * 1000 : 0;
  const produceCost = produceBaseCost + produceExtraCost;
  buttons.produceMovie.textContent = `🎥 Produce Movie (${currencySymbol}${formatMoney(produceCost)}) -50⚡${actionCooldowns.produceMovie > 0 ? ` (Available in ${actionCooldowns.produceMovie} weeks)` : ""}${actionUses.produceMovie >= MAX_ACTION_USES_PER_YEAR.produceMovie ? " (Yearly limit reached)" : ""}`;
  buttons.produceMovie.disabled = !actionAvailability.produceMovie || energy < 50 || money < convertCurrency(produceCost) || fame < 10;
  
  buttons.shortFilm = document.getElementById("shortFilmBtn");
buttons.shortFilm.textContent = `🎥 Release Short Film on TikTok -30⚡`;
buttons.shortFilm.disabled = energy < 30 || scripts < 1 || practiceXP < 7 || followers < 1000;

buttons.scheduleVideo = document.getElementById("scheduleVideoBtn");
buttons.scheduleVideo.textContent = `📅 Schedule Video Release -10⚡`;
buttons.scheduleVideo.disabled = energy < 10 || followers < 10000 || videoLibrary.filter(v => !v.isReleased && v.releaseWeek === 0).length === 0;
}

    function generateReview(isSuccess, reward) {
      const critics = [
        { name: "Jane Doe", outlet: "Variety" },
        { name: "John Smith", outlet: "The Hollywood Reporter" },
        { name: "Emma Lee", outlet: "Screen Daily" },
        { name: "Michael Brown", outlet: "IndieWire" },
        { name: "Sarah Chen", outlet: "The Wrap" }
      ];
      const positiveReviews = [
        "A captivating performance that lights up the screen.",
        "Shows remarkable emotional depth for their experience level.",
        "A breakout star with undeniable charisma.",
        "Delivers a nuanced portrayal that resonates with audiences.",
        "Commands every scene with confidence and skill."
      ];
      const neutralReviews = [
        "A solid effort, though there's room to grow.",
        "Shows promise but needs more polish in key moments.",
        "A decent performance that blends into the ensemble.",
        "Competent acting, but lacks a defining spark.",
        "A serviceable turn, with potential for more impact."
      ];
      const negativeReviews = [
        "Struggles to connect emotionally with the role.",
        "Performance feels flat and uninspired.",
        "Lacks the screen presence needed for a lead role.",
        "Delivery feels forced and unconvincing.",
        "Seems out of their depth in this production."
      ];

      const critic = critics[Math.floor(Math.random() * critics.length)];
      let reviewSnippets = [];
      let fameChange = 0;

      if (practiceXP >= 20 && fame >= 50 && isSuccess) {
  reviewSnippets = [positiveReviews[Math.floor(Math.random() * positiveReviews.length)]];
  if (Math.random() < 0.3) {
    reviewSnippets.push(positiveReviews[Math.floor(Math.random() * positiveReviews.length)]);
    fameChange = 0.01; // Reduced from 0.1
  } else {
    reviewSnippets.push(neutralReviews[Math.floor(Math.random() * neutralReviews.length)]);
  }
} else if (practiceXP >= 7 && fame >= 20 && isSuccess) {
  reviewSnippets = [positiveReviews[Math.floor(Math.random() * positiveReviews.length)]];
  reviewSnippets.push(neutralReviews[Math.floor(Math.random() * neutralReviews.length)]);
} else if (practiceXP < 7 && fame < 20 && isSuccess) {
  reviewSnippets = [neutralReviews[Math.floor(Math.random() * neutralReviews.length)]];
  if (Math.random() < 0.5) {
    reviewSnippets.push(positiveReviews[Math.floor(Math.random() * positiveReviews.length)]);
  } else {
    reviewSnippets.push(neutralReviews[Math.floor(Math.random() * neutralReviews.length)]);
  }
} else if (!isSuccess) {
  reviewSnippets = [negativeReviews[Math.floor(Math.random() * negativeReviews.length)]];
  if (Math.random() < 0.5) {
    reviewSnippets.push(neutralReviews[Math.floor(Math.random() * neutralReviews.length)]);
  } else {
    reviewSnippets.push(negativeReviews[Math.floor(Math.random() * negativeReviews.length)]);
    if (practiceXP < 7 && fame < 20) fameChange = -0.5; // Increased loss from -0.1
  }
}
if (reward && reward > 5000) {
  reviewSnippets[0] = positiveReviews[Math.floor(Math.random() * positiveReviews.length)];
  fameChange = fameChange || 0.01; // Reduced from 0.1
}

      return { review: `${critic.name}, ${critic.outlet}: ${reviewSnippets.join(" ")}`, fameChange };
    }

    async function generateFollowerReaction(isSuccess, isBlockbuster = false) {
      let followerGain = 0;
      let fameChange = 0;
      let reaction = "";

      if (isSuccess) {
  followerGain = isBlockbuster ? Math.floor(Math.random() * 151) + 50 : Math.floor(Math.random() * 101) + 50;
  fameChange = 0.025; // Reduced from 0.25
  reaction = isBlockbuster
    ? `📱 Your fans are buzzing about your blockbuster role! +${followerGain} Followers, +0.025 Fame`
    : `📱 Your followers loved seeing you in that role! +${followerGain} Followers, +0.025 Fame`;
} else {
  followerGain = Math.floor(Math.random() * 41) + 10;
  reaction = `📱 Some fans noticed your audition attempt. +${followerGain} Followers`;
}
fame += fameChange;

      followers += followerGain;
      fame += fameChange;
      await showInfoModal(reaction);
      fame = Math.floor(fame || 1);
      updateStats();
      saveGame();
    }

    async function startGame() {
  const fullName = document.getElementById("fullName").value;
  const stageName = document.getElementById("stageName").value;
  age = Number(document.getElementById("age").value);
  const city = document.getElementById("city").value;
  startDate = document.getElementById("startDate").value;
  currencySymbol = document.getElementById("currency").value;

  year = 1; // Initialize year for new game

  if (!fullName || !stageName || !age || !city || !startDate) {
    let retry = await showModal("Please fill in all fields, including the starting date. Retry?");
    if (retry) return;
    else return;
  }
  if (age < 17) {
    let retry = await showModal("Minimum age to enter is 17. Retry?");
    if (retry) return;
    else return;
  }
  if (age > 60) {
    let retry = await showModal("Maximum age to enter is 60. Retry?");
    if (retry) return;
    else return;
  }

  money = getStartingMoney(currencySymbol);

  document.getElementById("nameDisplay").textContent = `${stageName} (${fullName})`;
  document.getElementById("cityDisplay").textContent = city;
  document.getElementById("ageDisplay").textContent = age;
  document.getElementById("startDateDisplay").textContent = startDate;
  document.getElementById("currencySymbol").textContent = currencySymbol;

  document.getElementById("profileForm").style.display = "none";
  document.getElementById("game").style.display = "block";
  updateStats();
  updateLifestyleButtons();
  saveGame();
}

    async function chooseAction(choice, cost) {
  // Check energy requirement
  if (energy < cost) {
    await showInfoModal("Not enough energy for this action. Try another action?");
    return;
  }

  let outcome = "";

  if (choice === 1) {
    // Audition
    if (fame >= 50) {
      await showInfoModal("You're too famous for these auditions. Try something else.");
      return;
    }
    if (money < convertCurrency(1000)) {
      await showInfoModal(`You need at least ${currencySymbol}${formatMoney(1000)} to audition. Try another action?`);
      return;
    }
    actionUses.audition++;
    energy -= cost;
    money -= convertCurrency(1000);
    let chance = Math.random() + (hasAgent ? 0.1 : 0) + (practiceXP * 0.01);
    if (chance > 0.5) {
      let reward = 500 + Math.floor(Math.random() * 501);
      if (fame >= 20) reward = 1000 + Math.floor(Math.random() * 1001);
      if (fame >= 40) reward = 2000 + Math.floor(Math.random() * 2001);
      money += convertCurrency(reward);
      let { review, fameChange } = generateReview(true, reward);
      await showInfoModal(`${review} (${fameChange >= 1 ? '+' : ''}${fameChange} Fame)`);
      fame = Math.max(fame + fameChange, 1);
      await generateFollowerReaction(true);
      outcome = `🎤 You nailed the audition! Earned ${currencySymbol}${formatMoney(reward)}`;
    } else {
      let { review, fameChange } = generateReview(false);
      await showInfoModal(`${review} (${fameChange >= 1 ? '+' : ''}${fameChange} Fame)`);
      fame = Math.max(fame + fameChange, 1);
      await generateFollowerReaction(false);
      outcome = "😕 Your audition didn’t go well.";
    }
  } else if (choice === 2) {
    // New TikTok post selection logic
    if (energy < cost) {
      await showInfoModal("Not enough energy to post on TikTok. Try another action?");
      return;
    }
    actionUses.tiktok++;
    energy -= cost;
    outcome = await selectTikTokPost();
    await showInfoModal(`🗓️ Week ${week} Action:\n${outcome}`);
    fame = Math.floor(fame || 1);
    updateStats();
    updateWeekChoices();
    updateLifestyleButtons();
    checkEnergy();
    saveGame();
  } else if (choice === 3) {
    // Attend Workshop
    if (practiceXP >= 100) {
      await showInfoModal("Your skill is already at Master level. No need for workshops!");
      return;
    }
    actionUses.workshop++;
    energy -= cost;
    const xpGain = Math.random() < 0.5 ? 2 : 1; // 50% chance for 2 XP, else 1 XP
    practiceXP += xpGain;
    skill = getSkillByXP(practiceXP);
    outcome = `🎓 You attended an acting workshop and learned new techniques! +${xpGain} Skill XP`;
    if (Math.random() < 0.1) {
      fame += 0.1;
      outcome += ", +0.1 Fame due to workshop recognition";
    }
  } else if (choice === 4) {
    // Hire Talent Agent
    if (hasAgent) {
      await showInfoModal("You already have a talent agent. Try another action?");
      return;
    }
    const agentCost = convertCurrency(2000);
    if (money < agentCost) {
      await showInfoModal(`Not enough money to hire a talent agent (${currencySymbol}${formatMoney(agentCost)} required). Try another action?`);
      return;
    }
    actionUses.hireAgent = (actionUses.hireAgent || 0) + 1; // Track usage
    energy -= cost;
    money -= agentCost;
    hasAgent = true;
    outcome = `🤝 You hired a talent agent for ${currencySymbol}${formatMoney(agentCost)}! They may unlock new opportunities.`;
    if (Math.random() < 0.3) {
      actionAvailability.blockbuster = true; // Chance to unlock blockbuster opportunity
      outcome += " Your agent secured a blockbuster audition opportunity!";
    }
  } else if (choice === 5) {
    // Take a Side Job
    actionUses.sideJob++;
    energy -= cost;
    const jobReward = convertCurrency(500 + Math.floor(Math.random() * 501)); // $500-$1000
    money += jobReward;
    outcome = `💼 You worked a side job and earned ${currencySymbol}${formatMoney(jobReward)}!`;
    if (Math.random() < 0.2) {
      fame = Math.max(fame - 0.1, 1);
      outcome += " -0.1 Fame due to being spotted in a non-acting role.";
    }
  } else if (choice === 6) {
    // Blockbuster
    if (!actionAvailability.blockbuster) {
      await showInfoModal("No blockbuster roles are available right now. Try another action?");
      return;
    }
    if (actionUses.blockbuster >= MAX_ACTION_USES_PER_YEAR.blockbuster) {
      await showInfoModal("You've reached the yearly limit for blockbuster roles. Try another action?");
      return;
    }
    if (fame < 45) {
      await showInfoModal("You need at least 45 Fame for a blockbuster movie role. Try another action?");
      return;
    }
    actionUses.blockbuster++;
    energy -= cost;
    actionAvailability.blockbuster = false;
    actionCooldowns.blockbuster = 26;
    let reward = 2000 + ((fame || 1) * 100);
    let accept = await showModal(`🎬 You've been offered a blockbuster movie role! Accept? (+${currencySymbol}${formatMoney(reward)}, +1 Fame, +1 Blockbuster)`);
    if (accept) {
      money += convertCurrency(reward);
      fame += 1;
      blockbusters += 1;
      let { review, fameChange } = generateReview(true, reward);
      await showInfoModal(`${review} (${fameChange >= 0 ? '+' : ''}${fameChange} Fame)`);
      fame = Math.max(fame + fameChange, 1);
      await generateFollowerReaction(true, true);
      outcome = `🎬 You starred in a blockbuster movie! Earned ${currencySymbol}${formatMoney(reward)}, +1 Fame, +1 Blockbuster`;
    } else {
      outcome = "🙅 You declined the blockbuster movie role.";
    }
  }

  // Ensure fame doesn't drop below 1
  fame = Math.max(fame, 1);

  // Display outcome (for non-TikTok actions)
  if (choice !== 2) {
    await showInfoModal(`🗓️ Week ${week} Action:\n${outcome}`);
  }

  // Update UI and save
  updateStats();
  updateWeekChoices();
  updateLifestyleButtons();
  checkEnergy();
  saveGame();
}

// New function to handle TikTok post selection
async function selectTikTokPost() {
  const postOptions = [
    { name: "Monologue Acting", requiresXP: 4, minFollowers: 50, maxFollowers: 300, minFame: 0.10, maxFame: 1, successChance: 0.9 },
    { name: "Dancing Video", requiresXP: 0, minFollowers: 20, maxFollowers: 400, minFame: 0.8, maxFame: 1.0, successChance: 0.9 },
    { name: "Picture with Music", requiresXP: 0, minFollowers: 10, maxFollowers: 150, minFame: 0.6, maxFame: 0.9, successChance: 0.9 },
    { name: "Normal TikTok Video", requiresXP: 0, minFollowers: 1, maxFollowers: 200, minFame: 0.9, maxFame: 1.5, successChance: 0.9 }
  ];

  // Generate modal message with options
  let modalMessage = "📲 Choose your TikTok post type:\n";
  postOptions.forEach((option, index) => {
    modalMessage += `${index + 1}. ${option.name}${option.requiresXP > 0 ? ` (Requires ${option.requiresXP} XP)` : ""}\n`;
  });

  // Create a custom modal for selecting the post type
  return new Promise((resolve) => {
    const modalContent = document.querySelector(".modal-content");
    modalContent.innerHTML = `
      <h3>Choose TikTok Post</h3>
      <p>${modalMessage.replace(/\n/g, "<br>")}</p>
      <div id="modalButtons" class="modal-buttons">
        ${postOptions
          .map(
            (option, index) =>
              `<button class="modal-btn" onclick="resolveTikTokModal(${index})" ${option.requiresXP > practiceXP ? "disabled" : ""}>${option.name}</button>`
          )
          .join("")}
      </div>
    `;
    document.getElementById("modal").style.display = "flex";
    window.resolveTikTokModal = (index) => {
      document.getElementById("modal").style.display = "none";
      const option = postOptions[index];
      let outcome = "";
      if (Math.random() < option.successChance) {
        // Successful post
        const followerGain = Math.floor(Math.random() * (option.maxFollowers - option.minFollowers + 1)) + option.minFollowers;
        const fameGain = Number((Math.random() * (option.maxFame - option.minFame) + option.minFame).toFixed(2));
        followers += followerGain;
        fame += fameGain;
        outcome = `📈 Your ${option.name} post went viral! +${followerGain} Followers, +${fameGain} Fame`;
      } else {
        // Less successful post
        const followerGain = Math.floor(Math.random() * (Math.floor(option.minFollowers / 2) + 1)) + 1;
        const fameGain = Number((option.minFame / 2).toFixed(2));
        followers += followerGain;
        fame += fameGain;
        outcome = `📱 Your ${option.name} post got some views. +${followerGain} Followers, +${fameGain} Fame`;
      }
      resolve(outcome);
    };
  });
}

    async function practice() {
  if (energy < 30) {
    await showModal("You're too tired to practice. Try another action?");
    return;
  }
  actionUses.practice++; // Track Practice usage
  energy -= 30;
  if (Math.random() < 0.3) practiceXP++;
  let outcome = "🧘 You practiced." + (practiceXP > 0 ? " XP +1. You're improving slowly." : " No XP gained this time.");
  if (Math.random() < 0.1) fame += 0.25;
  fame = Math.floor(fame || 1);
  skill = getSkillByXP(practiceXP);
  await showInfoModal(`🗓️ Week ${week} Action:\n${outcome}`);
  updateStats();
  updateLifestyleButtons();
  checkEnergy();
  saveGame();
}

    async function writeScript() {
  if (!actionAvailability.writeScript) {
    await showModal("You're not inspired to write a script right now. Try another action?");
    return;
  }
  if (actionUses.writeScript >= MAX_ACTION_USES_PER_YEAR.writeScript) {
    await showModal("You've reached the yearly limit for writing scripts. Try another action?");
    return;
  }
  if (energy < 30) {
    await showModal("Not enough energy to write a script. Try another action?");
    return;
  }
  if (practiceXP < 7) {
    await showModal("You need at least Improving skill (7 XP) to write a script. Try another action?");
    return;
  }

  // Determine max genres based on skill
  const maxGenres = practiceXP >= 30 ? 3 : practiceXP >= 15 ? 2 : 1;

  // Generate genre options
  let genreOptions = genres
    .filter(genre => practiceXP >= genre.minXP)
    .map(
      (genre, index) =>
        `<label style="display: block; margin: 5px 0;"><input type="checkbox" class="genre-checkbox" data-index="${index}" /> ${genre.name} (Requires ${genre.minXP} XP)</label>`
    )
    .join("");

  // Debug: Log available genres
  console.log("Available genres:", genres.filter(genre => practiceXP >= genre.minXP));

  // Generate modal message
  let modalMessage = `📝 Choose 1–${maxGenres} genres for your script:`;

  // Create a custom modal for selecting genres
  return new Promise((resolve) => {
    const modalContent = document.querySelector(".modal-content");
    modalContent.innerHTML = `
      <h3>Choose Script Genres</h3>
      <p>${modalMessage}</p>
      <div style="text-align: left; margin-bottom: 15px;">${genreOptions}</div>
      <div id="modalButtons" class="modal-buttons">
        <button class="modal-btn yes" onclick="submitGenres()">Submit</button>
        <button class="modal-btn no" onclick="resolveModal(false)">Cancel</button>
      </div>
    `;
    document.getElementById("modal").style.display = "flex";

    // Function to handle genre submission
    window.submitGenres = async () => {
      const checkboxes = document.querySelectorAll(".genre-checkbox:checked");
      const selectedGenres = Array.from(checkboxes).map(cb => genres[Number(cb.dataset.index)]);
      console.log("Selected genres:", selectedGenres); // Debug
      if (selectedGenres.length < 1 || selectedGenres.length > maxGenres) {
        await showInfoModal(`Please select 1–${maxGenres} genres.`);
        return;
      }

      document.getElementById("modal").style.display = "none";
      energy -= 30;
      scripts += 1;
      actionCooldowns.writeScript = 8; // 2-month cooldown
      actionUses.writeScript++;

      // Calculate script quality
      let qualityChance = Math.min(practiceXP * 0.02, 0.8);
      const avgQualityMultiplier = selectedGenres.length > 0
        ? selectedGenres.reduce((sum, g) => sum + g.qualityMultiplier, 0) / selectedGenres.length
        : 1.0;
      qualityChance *= avgQualityMultiplier;
      let scriptQuality = Math.random() < qualityChance ? "High-Quality" : "Standard";

      // Store script with genres
      const scriptData = {
        quality: scriptQuality,
        genres: selectedGenres.map(g => g.name)
      };
      scriptQualities.push(scriptData);

      let outcome = `✍️ You wrote a ${scriptQuality} script (${scriptData.genres.join(", ")})! +1 Script`;
      if (Math.random() < 0.05 && fame >= 20) {
        fame += 0.2;
        outcome += " +0.2 Fame due to industry buzz!";
      }
      await showInfoModal(`🗓️ Week ${week} Action:\n${outcome}`);
      fame = Math.floor(fame || 1);
      updateStats();
      updateWeekChoices();
      updateLifestyleButtons();
      checkEnergy();
      saveGame();
      resolve(outcome);
    };
  });
}

    async function sellScript() {
  if (energy < 20) {
    await showModal("Not enough energy to sell a script. Try another action?");
    return;
  }
  if (scripts < 1) {
    await showModal("You need a script to sell. Try another action?");
    return;
  }
  if (practiceXP < 7) {
    await showModal("You need at least Improving skill (7 XP) to sell a script. Try another action?");
    return;
  }

  // Generate modal message with script options
  let modalMessage = "💸 Select a script to sell:\n";
  let scriptOptions = scriptQualities
    .map((script, index) => {
      const genresText = script.genres.length > 0 ? script.genres.join(", ") : "General";
      return `<button class="modal-btn" onclick="selectScriptToSell(${index})">${script.quality} Script (${genresText})</button>`;
    })
    .join("");

  if (scriptOptions === "") {
    await showModal("No scripts available to sell. Try another action?");
    return;
  }

  // Create a custom modal for selecting a script
  return new Promise((resolve) => {
    const modalContent = document.querySelector(".modal-content");
    modalContent.innerHTML = `
      <h3>Select Script to Sell</h3>
      <p>${modalMessage.replace(/\n/g, "<br>")}</p>
      <div id="modalButtons" class="modal-buttons">
        ${scriptOptions}
        <button class="modal-btn no" onclick="resolveModal(false)">Cancel</button>
      </div>
    `;
    document.getElementById("modal").style.display = "flex";

    // Function to handle script selection
    window.selectScriptToSell = async (index) => {
      document.getElementById("modal").style.display = "none";
      let scriptData = scriptQualities[index]; // Get selected script
      let scriptQuality = scriptData.quality;
      let scriptGenres = scriptData.genres.length > 0 ? scriptData.genres : ["General"];

      // Define buyers based on fame
      const bigBuyers = [
        { name: "Netflix", type: "Streaming Platform" },
        { name: "Warner Bros.", type: "Studio" },
        { name: "Universal Pictures", type: "Studio" },
        { name: "Lionsgate", type: "Studio" },
        { name: "A24", type: "Independent Studio" }
      ];
      const smallBuyers = [
        { name: "Jane Doe Productions", type: "Independent Producer" },
        { name: "Local Theater Group", type: "Community Theater" },
        { name: "Indie Filmmaker", type: "Independent Filmmaker" },
        { name: "Student Film Project", type: "Student Production" }
      ];

      // Determine buyer based on fame
      let buyerPool = fame >= 30 ? bigBuyers : smallBuyers;
      const buyer = buyerPool[Math.floor(Math.random() * buyerPool.length)];

      // Calculate script value based on fame, skill, quality, and genres
      let baseValue;
      if (fame < 20) {
        baseValue = 500 + Math.floor(Math.random() * 501);
      } else if (fame < 50) {
        baseValue = 2000 + Math.floor(Math.random() * 3001);
      } else {
        baseValue = 10000 + Math.floor(Math.random() * 20001);
      }

      let qualityMultiplier = scriptQuality === "High-Quality" ? 1.5 : 1;
      let skillMultiplier = Math.min(practiceXP * 0.05, 2);
      let genreMultiplier = scriptGenres.length > 0
        ? scriptGenres.reduce((sum, genreName) => {
            const genre = genres.find(g => g.name === genreName) || { qualityMultiplier: 1 };
            return sum + genre.qualityMultiplier;
          }, 0) / scriptGenres.length
        : 1;
      let scriptValue = Math.round(baseValue * qualityMultiplier * skillMultiplier * genreMultiplier);

      let saleChance = Math.min(fame * 0.01 + (scriptQuality === "High-Quality" ? 0.2 : 0), 0.9);
      if (fame < 50 && Math.random() > saleChance) {
        scriptValue = Math.round(scriptValue * 0.5);
      }

      const convertedValue = convertCurrency(scriptValue);
      let accept = await showModal(`💸 ${buyer.name} (${buyer.type}) wants to buy your ${scriptQuality} ${scriptGenres.join(", ")} script for ${currencySymbol}${formatMoney(convertedValue)}! Accept?`);
      let outcome = "";
      if (accept) {
        energy -= 20; // Deduct energy only on acceptance
        scripts -= 1; // Decrement script count
        scriptQualities.splice(index, 1); // Remove selected script
        money += convertedValue;
        if (fame >= 30 && scriptQuality === "High-Quality" && Math.random() < 0.2) {
          fame += 0.5;
          outcome = `💸 Sold your ${scriptQuality} ${scriptGenres.join(", ")} script to ${buyer.name} for ${currencySymbol}${formatMoney(convertedValue)}! +0.5 Fame due to industry recognition.`;
          await generateFollowerReaction(true);
        } else if (Math.random() < 0.1) {
          fame += 0.25;
          outcome = `💸 Sold your ${scriptQuality} ${scriptGenres.join(", ")} script to ${buyer.name} for ${currencySymbol}${formatMoney(convertedValue)}! +0.25 Fame`;
        } else {
          outcome = `💸 Sold your ${scriptQuality} ${scriptGenres.join(", ")} script to ${buyer.name} for ${currencySymbol}${formatMoney(convertedValue)}!`;
        }
      } else {
        outcome = `🙅 You declined to sell your ${scriptQuality} ${scriptGenres.join(", ")} script to ${buyer.name}.`;
      }

      await showInfoModal(`🗓️ Week ${week} Action:\n${outcome}`);
      fame = Math.floor(fame || 1);
      updateStats();
      updateLifestyleButtons();
      checkEnergy();
      saveGame();
      resolve(outcome);
    };
  });
}

    async function attendAListParty() {
  if (!actionAvailability.aListParty) {
    await showModal("No A-List party invitations are available right now. Try another action?");
    return;
  }
  if (actionUses.aListParty >= MAX_ACTION_USES_PER_YEAR.aListParty) {
    await showModal("You've reached the yearly limit for attending A-List parties. Try another action?");
    return;
  }
  if (energy < 25) {
    await showModal("Not enough energy to attend an A-List party. Try another action?");
    return;
  }
  if (money < 2500) {
    await showModal(`Not enough money to attend an A-List party (${currencySymbol}2,500 required). Try another action?`);
    return;
  }
  if (fame < 20) {
    await showModal("You need at least 20 Fame to attend an A-List party. Try another action?");
    return;
  }
  energy -= 25;
  money -= 2500;
  actionCooldowns.aListParty = 8; // 2-month cooldown
  actionUses.aListParty++;
  actionAvailability.aListParty = false;
  let outcome = "";
  let chance = Math.random();
  if (chance < 0.25) { // Slightly reduced success chance
    const partyReward = Math.floor(Math.random() * 3001) + 3000; // Lower reward
    let accept = await showModal(`🎉 You networked at the A-List party and landed a movie role! Accept? (+${currencySymbol}${partyReward}, +1.5 Fame, +1 Blockbuster)`);
    if (accept) {
      fame += 1.5; // Reduced fame reward
      blockbusters += 1;
      money += partyReward;
      outcome = `🎉 You accepted the movie role! +${currencySymbol}${partyReward}, +1.5 Fame, +1 Blockbuster`;
      let { review, fameChange } = generateReview(true, partyReward);
      await showInfoModal(`${review} (${fameChange >= 0 ? '+' : ''}${fameChange} Fame)`);
      fame = Math.max(fame + fameChange, 1);
      await generateFollowerReaction(true, true);
    } else {
      outcome = "🙅 You declined the movie role.";
    }
  } else if (chance < 0.5) {
    fame = Math.max(fame - 0.5, 1); // Reduced fame penalty
    outcome = `😳 A scandal at the A-List party hurt your reputation! -0.5 Fame`;
  } else {
    fame += 0.2; // Reduced fame gain
    outcome = `🥂 You mingled at the A-List party and made some connections. +0.2 Fame`;
  }
  await showInfoModal(`🗓️ Week ${week} Action:\n${outcome}`);
  fame = Math.floor(fame || 1);
  updateStats();
  updateWeekChoices();
  updateLifestyleButtons();
  checkEnergy();
  saveGame();
}

    async function voiceActVideoGame() {
  if (!actionAvailability.voiceAct) {
    await showModal("No voice acting roles are available right now. Try another action?");
    return;
  }
  if (actionUses.voiceAct >= MAX_ACTION_USES_PER_YEAR.voiceAct) {
    await showModal("You've reached the yearly limit for voice acting roles. Try another action?");
    return;
  }
  if (energy < 30) {
    await showModal("Not enough energy to voice act in a video game. Try another action?");
    return;
  }
  if (fame < 15) {
    await showModal("You need at least 15 Fame to voice act in a video game. Try another action?");
    return;
  }
  energy -= 30;
  actionCooldowns.voiceAct = 12; // 3-month cooldown
  actionUses.voiceAct++;
  actionAvailability.voiceAct = false;
  let outcome = "";
  let chance = Math.random() + (practiceXP * 0.01);
  if (chance < 0.5) { // Reduced success chance
    const followerGain = Math.floor(Math.random() * 101) + 50; // Reduced follower gain
    fame += 0.75; // Reduced fame reward
    followers += followerGain;
    voiceActingIncome = 300; // Reduced income to slow cash earning
    voiceActingWeeks = 8; // Reduced duration
    outcome = `🎮 Your video game voice acting role was a hit! +${followerGain} Followers, +0.75 Fame, +${currencySymbol}300/week for 8 weeks`;
    await generateFollowerReaction(true);
  } else {
    fame += 0.2; // Reduced fame gain
    outcome = `😕 Your video game voice acting role didn’t stand out, but you gained some exposure. +0.2 Fame`;
    await generateFollowerReaction(false);
  }
  await showInfoModal(`🗓️ Week ${week} Action:\n${outcome}`);
  fame = Math.floor(fame || 1);
  updateStats();
  updateWeekChoices();
  updateLifestyleButtons();
  checkEnergy();
  saveGame();
}

    async function doBrandEndorsement() {
  if (!actionAvailability.endorsement) {
    await showModal("No brand endorsement offers are available right now. Try another action?");
    return;
  }
  if (actionUses.endorsement >= MAX_ACTION_USES_PER_YEAR.endorsement) {
    await showModal("You've reached the yearly limit for brand endorsements. Try another action?");
    return;
  }
  if (energy < 20) {
    await showModal("Not enough energy to do a brand endorsement deal. Try another action?");
    return;
  }
  if (money < 1000) {
    await showModal(`Not enough money for a brand endorsement deal (${currencySymbol}1,000 required). Try another action?`);
    return;
  }
  if (fame < 30) {
    await showModal("You need at least 30 Fame to do a brand endorsement deal. Try another action?");
    return;
  }
  energy -= 20;
  money -= 1000;
  actionCooldowns.endorsement = 8; // 2-month cooldown
  actionUses.endorsement++;
  actionAvailability.endorsement = false;
  let outcome = "";
  let chance = Math.random() + (practiceXP * 0.01);
  if (chance < 0.6) { // Reduced success chance
    const endorsementReward = Math.floor(Math.random() * 7001) + 5000; // Reduced reward
    const followerGain = Math.floor(Math.random() * 151) + 50; // Reduced follower gain
    fame += 0.4; // Reduced fame reward
    followers += followerGain;
    money += endorsementReward;
    outcome = `📺 Your brand endorsement deal was a success! +${currencySymbol}${endorsementReward}, +${followerGain} Followers, +0.4 Fame`;
  } else {
    fame += 0.2; // Reduced fame gain
    outcome = `😕 The brand endorsement deal didn’t resonate, but you gained some exposure. +0.2 Fame`;
  }
  await showInfoModal(`🗓️ Week ${week} Action:\n${outcome}`);
  fame = Math.floor(fame || 1);
  updateStats();
  updateWeekChoices();
  updateLifestyleButtons();
  checkEnergy();
  saveGame();
}

    async function attendNetworkingEvent() {
  if (!actionAvailability.networking) {
    await showModal("No industry networking events are available right now. Try another action?");
    return;
  }
  if (actionUses.networking >= MAX_ACTION_USES_PER_YEAR.networking) {
    await showModal("You've reached the yearly limit for networking events. Try another action?");
    return;
  }
  if (energy < 25) {
    await showModal("Not enough energy to attend an industry networking event. Try another action?");
    return;
  }
  if (money < 2000) {
    await showModal(`Not enough money to attend an industry networking event (${currencySymbol}2,000 required). Try another action?`);
    return;
  }
  if (fame < 25) {
    await showModal("You need at least 25 Fame to attend an industry networking event. Try another action?");
    return;
  }
  if (practiceXP < 20) {
    await showModal("You need at least Pro skill (20 XP) to attend an industry networking event. Try another action?");
    return;
  }
  energy -= 25;
  money -= 2000;
  actionCooldowns.networking = 8; // 2-month cooldown
  actionUses.networking++;
  actionAvailability.networking = false;
  let outcome = "";
  let chance = Math.random();
  if (chance < 0.2) { // Reduced success chance
    const producerReward = Math.floor(Math.random() * 4001) + 4000; // Reduced reward
    let accept = await showModal(`🤝 You met a top producer at the networking event and landed a big role! Accept? (+${currencySymbol}${producerReward}, +1.5 Fame, +1 Blockbuster)`);
    if (accept) {
      fame += 1.5; // Reduced fame reward
      blockbusters += 1;
      money += producerReward;
      outcome = `🤝 You accepted the big role! +${currencySymbol}${producerReward}, +1.5 Fame, +1 Blockbuster`;
      let { review, fameChange } = generateReview(true, producerReward);
      await showInfoModal(`${review} (${fameChange >= 0 ? '+' : ''}${fameChange} Fame)`);
      fame = Math.max(fame + fameChange, 1);
      await generateFollowerReaction(true, true);
    } else {
      outcome = "🙅 You declined the big role.";
    }
  } else if (chance < 0.5) { // Adjusted probability
    const callbackReward = Math.floor(Math.random() * 2001) + 1500; // Reduced reward
    let isBlockbuster = Math.random() < 0.4; // Reduced blockbuster chance
    let accept = await showModal(`🎬 You got a callback for a supporting role at the networking event! Accept? (+${currencySymbol}${callbackReward}, +0.75 Fame${isBlockbuster ? ", +1 Blockbuster" : ""})`);
    if (accept) {
      fame += 0.75; // Reduced fame reward
      money += callbackReward;
      if (isBlockbuster) blockbusters += 1;
      outcome = `🎬 You accepted the supporting role! +${currencySymbol}${callbackReward}, +0.75 Fame${isBlockbuster ? ", +1 Blockbuster" : ""}`;
      let { review, fameChange } = generateReview(true, callbackReward);
      await showInfoModal(`${review} (${fameChange >= 0 ? '+' : ''}${fameChange} Fame)`);
      fame = Math.max(fame + fameChange, 1);
      await generateFollowerReaction(true, isBlockbuster);
    } else {
      outcome = "🙅 You declined the supporting role.";
    }
  } else {
    fame += 0.2; // Reduced fame gain
    outcome = `🤝 You made some connections at the networking event. +0.2 Fame`;
  }
  await showInfoModal(`🗓️ Week ${week} Action:\n${outcome}`);
  fame = Math.floor(fame || 1);
  updateStats();
  updateWeekChoices();
  updateLifestyleButtons();
  checkEnergy();
  saveGame();
}

    async function launchMerchLine() {
  if (!actionAvailability.merchLine) {
    await showModal("Your brand isn’t trending enough to launch a merchandise line right now. Try another action?");
    return;
  }
  if (actionUses.merchLine >= MAX_ACTION_USES_PER_YEAR.merchLine) {
    await showModal("You've reached the yearly limit for launching merchandise lines. Try another action?");
    return;
  }
  if (energy < 40) {
    await showModal("Not enough energy to launch a merchandise line. Try another action?");
    return;
  }
  if (money < 15000) {
    await showModal(`Not enough money to launch a merchandise line (${currencySymbol}15,000 required). Try another action?`);
    return;
  }
  if (fame < 35) {
    await showModal("You need at least 35 Fame to launch a merchandise line. Try another action?");
    return;
  }
  if (followers < 500) {
    await showModal("You need at least 500 Followers to launch a merchandise line. Try another action?");
    return;
  }
  energy -= 40;
  money -= 15000;
  actionCooldowns.merchLine = 26; // 6-month cooldown
  actionUses.merchLine++;
  actionAvailability.merchLine = false;
  merchFailed = false; // Reset failure state
  let outcome = "";
  let chance = Math.random() + (fame * 0.005);
  if (chance < 0.5) {
    const followerGain = Math.floor(Math.random() * 201) + 50;
    fame += 0.75;
    followers += followerGain;
    merchIncome = convertCurrency(800 + Math.floor(fame * 10)); // Income scales with fame
    merchWeeks = Infinity; // Indefinite income
    outcome = `🛍️ Your merchandise line was a hit! +${followerGain} Followers, +0.75 Fame, +${currencySymbol}${merchIncome}/week indefinitely`;
    await generateFollowerReaction(true);
  } else {
    fame += 0.2;
    outcome = `😕 Your merchandise line didn’t sell well, but you gained some exposure. +0.2 Fame`;
  }
  await showInfoModal(`🗓️ Week ${week} Action:\n${outcome}`);
  fame = Math.floor(fame || 1);
  updateStats();
  updateWeekChoices();
  updateLifestyleButtons();
  checkEnergy();
  saveGame();
}

    async function produceMovie() {
  if (!actionAvailability.produceMovie) {
    await showModal("You're not ready to produce a movie right now. Try another action?");
    return;
  }
  if (actionUses.produceMovie >= MAX_ACTION_USES_PER_YEAR.produceMovie) {
    await showModal("You've reached the yearly limit for producing movies. Try another action?");
    return;
  }
  if (energy < 50) {
    await showModal("Not enough energy to produce a movie. Try another action?");
    return;
  }
  const produceBaseCost = 10000;
  const produceExtraCost = fame >= 10 ? (fame - 10) * 1000 : 0;
  const produceCost = produceBaseCost + produceExtraCost;
  const convertedProduceCost = convertCurrency(produceCost);
  if (money < convertedProduceCost) {
    await showModal(`Not enough money to produce a movie (${currencySymbol}${formatMoney(convertedProduceCost)} required). Try another action?`);
    return;
  }
  if (fame < 10) {
    await showModal("You need at least 10 Fame to produce a movie. Try another action?");
    return;
  }
  energy -= 50;
  money -= convertedProduceCost;
  actionCooldowns.produceMovie = 12; // 3-month cooldown
  actionUses.produceMovie++;
  producedMovies += 1;
  movieRoyaltyWeeks = 5; // Set 5 weeks of royalties
  actionAvailability.produceMovie = false; // Temporarily disable until cooldown/conditions reset
  let outcome = "";
  let chance = Math.random() + (practiceXP * 0.01);
  let movieReward = convertCurrency(5000 + fame * 100); // Immediate earnings
  let royaltyPerMovie = convertCurrency(500 + fame * 50); // Royalty per movie for 5 weeks
  if (chance > 0.5) {
    fame += 1;
    money += movieReward;
    outcome = `🎥 You produced a successful movie! +${currencySymbol}${formatMoney(movieReward)}, +1 Fame, +${currencySymbol}${formatMoney(royaltyPerMovie)}/week royalties for 5 weeks`;
    let { review, fameChange } = generateReview(true, movieReward);
    await showInfoModal(`${review} (${fameChange >= 0 ? '+' : ''}${fameChange} Fame)`);
    fame = Math.max(fame + fameChange, 1);
    await generateFollowerReaction(true, true);
  } else {
    fame += 0.2;
    outcome = `🎥 You produced a movie, but it was average. +0.2 Fame, +${currencySymbol}${formatMoney(royaltyPerMovie)}/week royalties for 5 weeks`;
    await generateFollowerReaction(false);
  }
  await showInfoModal(`🗓️ Week ${week} Action:\n${outcome}`);
  fame = Math.floor(fame || 1);
  updateStats();
  updateWeekChoices();
  updateLifestyleButtons();
  checkEnergy();
  saveGame();
}

async function writeShortFilm() {
  if (energy < 30) {
    await showModal("Not enough energy to create a short film. Try another action?");
    return;
  }
  if (scripts < 1) {
    await showModal("You need a script to create a short film, sequel, or series episode. Try another action?");
    return;
  }
  if (practiceXP < 7) {
    await showModal("You need at least Improving skill (7 XP) to create a short film, sequel, or series episode. Try another action?");
    return;
  }
  if (followers < 10000) {
    await showModal("You need at least 10,000 Followers to create a short film, sequel, or series episode for meaningful impact. Try another action?");
    return;
  }

  // Create a modal to choose between new short film, sequel, or series episode
  return new Promise((resolve) => {
    const modalContent = document.querySelector(".modal-content");
    modalContent.classList.add("short-film");
    modalContent.innerHTML = `
      <h3>Create Video</h3>
      <p>🎥 Choose an option:</p>
      <div id="modalButtons" class="modal-buttons">
        <button class="modal-btn" onclick="createNewShortFilm()">New Short Film</button>
        <button class="modal-btn" onclick="createSequel()" ${videoLibrary.filter(v => v.isReleased && v.type === "Short Film").length === 0 ? "disabled" : ""}>Sequel</button>
        <button class="modal-btn" onclick="createSeriesEpisode()" ${videoLibrary.filter(v => v.isReleased && v.type === "Short Film").length === 0 ? "disabled" : ""}>Series Episode</button>
        <button class="modal-btn no" id="cancelActionBtn">Cancel</button>
      </div>
    `;
    document.getElementById("modal").style.display = "flex";

    // Handle cancel button
    document.getElementById("cancelActionBtn").onclick = () => {
      document.getElementById("modal").style.display = "none";
      modalContent.classList.remove("short-film");
      resolve(null);
    };

    // Function to create a new short film
    window.createNewShortFilm = async () => {
      document.getElementById("modal").style.display = "none";
      modalContent.classList.remove("short-film");

      // Generate script options for selection
      let scriptOptions = scriptQualities
        .map((script, index) => {
          const genresText = script.genres.length > 0 ? script.genres.join(", ") : "General";
          return `<button class="modal-btn" onclick="selectScriptForShortFilm(${index})">${script.quality} Script (${genresText})</button>`;
        })
        .join("");

      if (scriptOptions === "") {
        await showModal("No scripts available to create a short film. Try another action?");
        resolve(null);
        return;
      }

      // Modal for selecting script
      modalContent.classList.add("short-film");
      modalContent.innerHTML = `
        <h3>Select Script for Short Film</h3>
        <p>💸 Choose a script to produce your short film:</p>
        <div id="modalButtons" class="modal-buttons">
          ${scriptOptions}
          <button class="modal-btn no" id="cancelScriptBtn">Cancel</button>
        </div>
      `;
      document.getElementById("modal").style.display = "flex";

      // Function to handle script selection
      window.selectScriptForShortFilm = async (index) => {
        document.getElementById("modal").style.display = "none";
        modalContent.classList.remove("short-film");
        const selectedScript = scriptQualities[index];
        const scriptQuality = selectedScript.quality;
        const scriptGenres = selectedScript.genres.length > 0 ? selectedScript.genres : ["General"];

        // Modal for entering title, duration, and release week
        modalContent.classList.add("short-film");
        modalContent.innerHTML = `
          <h3>Create Short Film</h3>
          <p>🎥 Using ${scriptQuality} Script (${scriptGenres.join(", ")})</p>
          <input type="text" id="filmTitle" placeholder="Title (1-50 chars)" maxlength="50" style="width: 100%;">
          <input type="number" id="filmDuration" placeholder="Duration (1-5 min)" min="1" max="5" style="width: 100%;">
          <input type="number" id="releaseWeek" placeholder="Release (1-12 wks, 0 for library)" min="0" max="12" style="width: 100%;">
          <div id="modalButtons" class="modal-buttons">
            <button class="modal-btn yes" id="submitFilmBtn">Submit</button>
            <button class="modal-btn no" id="cancelFilmBtn">Cancel</button>
          </div>
        `;
        document.getElementById("modal").style.display = "flex";

        // Attach event listeners
        const submitBtn = document.getElementById("submitFilmBtn");
        const cancelBtn = document.getElementById("cancelFilmBtn");

        submitBtn.onclick = async () => {
          const title = document.getElementById("filmTitle").value.trim();
          const duration = Number(document.getElementById("filmDuration").value);
          const releaseOffset = Number(document.getElementById("releaseWeek").value);

          // Validate inputs
          if (!title || title.length < 1 || title.length > 50) {
            await showInfoModal("Please enter a valid title (1–50 characters).");
            return;
          }
          if (isNaN(duration) || duration < 1 || duration > 5) {
            await showInfoModal("Please enter a valid duration (1–5 minutes).");
            return;
          }
          if (isNaN(releaseOffset) || releaseOffset < 0 || releaseOffset > 12) {
            await showInfoModal("Please schedule release 0–12 weeks ahead (0 to store in library).");
            return;
          }

          document.getElementById("modal").style.display = "none";
          modalContent.classList.remove("short-film");
          energy -= 30;
          scripts -= 1;
          scriptQualities.splice(index, 1); // Remove the selected script

          // Calculate release week and year
          let targetWeek = releaseOffset === 0 ? 0 : week + releaseOffset;
          let targetYear = releaseOffset === 0 ? 0 : year;
          if (targetWeek > 52) {
            targetWeek -= 52;
            targetYear += 1;
          }

          // Store video in library with expected views
          const video = {
            title,
            type: "Short Film",
            seriesTitle: "",
            episodeNumber: 0,
            genres: scriptGenres,
            quality: scriptQuality,
            duration,
            releaseWeek: targetWeek,
            releaseYear: targetYear,
            isReleased: releaseOffset === 0 ? false : false,
            originalFilmIndex: -1,
            expectedViews: Math.floor(followers * (scriptQuality === "High-Quality" ? 0.2 : 0.1)) // Initial estimate for views
          };
          videoLibrary.push(video);

          let outcome = releaseOffset === 0
            ? `🎥 You created "${title}" (${scriptQuality}, ${duration} min, ${scriptGenres.join(", ")}) and stored it in your video library. Expected ~${video.expectedViews.toLocaleString()} views if released.`
            : `🎥 You created "${title}" (${scriptQuality}, ${duration} min, ${scriptGenres.join(", ")}) and scheduled it for release in Year ${targetYear}, Week ${targetWeek}. Expected ~${video.expectedViews.toLocaleString()} views.`;
          await showInfoModal(`🗓️ Week ${week} Action:\n${outcome}`);
          updateStats();
          updateWeekChoices();
          updateLifestyleButtons();
          checkEnergy();
          saveGame();
          resolve(outcome);
        };

        cancelBtn.onclick = () => {
          document.getElementById("modal").style.display = "none";
          modalContent.classList.remove("short-film");
          resolve(null);
        };
      };

      // Handle cancel button for script selection
      document.getElementById("cancelScriptBtn").onclick = () => {
        document.getElementById("modal").style.display = "none";
        modalContent.classList.remove("short-film");
        resolve(null);
      };
    };

    // Function to create a sequel
    window.createSequel = async () => {
      document.getElementById("modal").style.display = "none";
      modalContent.classList.remove("short-film");

      // Generate options for released short films
      let filmOptions = videoLibrary
        .map((video, index) => {
          if (video.isReleased && video.type === "Short Film") {
            return `<button class="modal-btn" onclick="selectFilmForSequel(${index})">${video.title} (${video.quality}, ${video.genres.join(", ")})</button>`;
          }
          return "";
        })
        .filter(opt => opt !== "")
        .join("");

      if (filmOptions === "") {
        await showModal("No released short films available for a sequel. Try another action?");
        resolve(null);
        return;
      }

      // Modal for selecting film
      modalContent.classList.add("short-film");
      modalContent.innerHTML = `
        <h3>Select Film for Sequel</h3>
        <p>🎥 Choose a released short film for the sequel:</p>
        <div id="modalButtons" class="modal-buttons">
          ${filmOptions}
          <button class="modal-btn no" id="cancelFilmBtn">Cancel</button>
        </div>
      `;
      document.getElementById("modal").style.display = "flex";

      // Function to handle film selection
      window.selectFilmForSequel = async (filmIndex) => {
        document.getElementById("modal").style.display = "none";
        modalContent.classList.remove("short-film");
        const originalFilm = videoLibrary[filmIndex];

        // Generate script options
        let scriptOptions = scriptQualities
          .map((script, index) => {
            const genresText = script.genres.length > 0 ? script.genres.join(", ") : "General";
            return `<button class="modal-btn" onclick="selectScriptForSequel(${index}, ${filmIndex})">${script.quality} Script (${genresText})</button>`;
          })
          .join("");

        if (scriptOptions === "") {
          await showModal("No scripts available to create a sequel. Try another action?");
          resolve(null);
          return;
        }

        // Modal for selecting script
        modalContent.classList.add("short-film");
        modalContent.innerHTML = `
          <h3>Select Script for Sequel</h3>
          <p>🎥 Creating sequel for "${originalFilm.title}" (${originalFilm.genres.join(", ")})</p>
          <div id="modalButtons" class="modal-buttons">
            ${scriptOptions}
            <button class="modal-btn no" id="cancelScriptBtn">Cancel</button>
          </div>
        `;
        document.getElementById("modal").style.display = "flex";

        // Function to handle script selection for sequel
        window.selectScriptForSequel = async (scriptIndex, filmIndex) => {
          document.getElementById("modal").style.display = "none";
          modalContent.classList.remove("short-film");
          const selectedScript = scriptQualities[scriptIndex];
          const scriptQuality = selectedScript.quality === "High-Quality" || Math.random() < 0.3 ? "High-Quality" : "Standard"; // Higher quality chance for sequels
          const scriptGenres = originalFilm.genres; // Use original film's genres

          // Modal for entering title, duration, and release week
          modalContent.classList.add("short-film");
          modalContent.innerHTML = `
            <h3>Create Sequel</h3>
            <p>🎥 Using ${scriptQuality} Script for "${originalFilm.title}" sequel (${scriptGenres.join(", ")})</p>
            <input type="text" id="filmTitle" placeholder="Title (1-50 chars, e.g., ${originalFilm.title}: Part 2)" maxlength="50" style="width: 100%;">
            <input type="number" id="filmDuration" placeholder="Duration (1-5 min)" min="1" max="5" style="width: 100%;">
            <input type="number" id="releaseWeek" placeholder="Release (1-12 wks, 0 for library)" min="0" max="12" style="width: 100%;">
            <div id="modalButtons" class="modal-buttons">
              <button class="modal-btn yes" id="submitFilmBtn">Submit</button>
              <button class="modal-btn no" id="cancelFilmBtn">Cancel</button>
            </div>
          `;
          document.getElementById("modal").style.display = "flex";

          // Attach event listeners
          const submitBtn = document.getElementById("submitFilmBtn");
          const cancelBtn = document.getElementById("cancelFilmBtn");

          submitBtn.onclick = async () => {
            const title = document.getElementById("filmTitle").value.trim();
            const duration = Number(document.getElementById("filmDuration").value);
            const releaseOffset = Number(document.getElementById("releaseWeek").value);

            // Validate inputs
            if (!title || title.length < 1 || title.length > 50) {
              await showInfoModal("Please enter a valid title (1–50 characters).");
              return;
            }
            if (isNaN(duration) || duration < 1 || duration > 5) {
              await showInfoModal("Please enter a valid duration (1–5 minutes).");
              return;
            }
            if (isNaN(releaseOffset) || releaseOffset < 0 || releaseOffset > 12) {
              await showInfoModal("Please schedule release 0–12 weeks ahead (0 to store in library).");
              return;
            }

            document.getElementById("modal").style.display = "none";
            modalContent.classList.remove("short-film");
            energy -= 30;
            scripts -= 1;
            scriptQualities.splice(scriptIndex, 1); // Remove the selected script

            // Calculate release week and year
            let targetWeek = releaseOffset === 0 ? 0 : week + releaseOffset;
            let targetYear = releaseOffset === 0 ? 0 : year;
            if (targetWeek > 52) {
              targetWeek -= 52;
              targetYear += 1;
            }

            // Store video in library with expected views
            const video = {
              title,
              type: "Sequel",
              seriesTitle: "",
              episodeNumber: 0,
              genres: scriptGenres,
              quality: scriptQuality,
              duration,
              releaseWeek: targetWeek,
              releaseYear: targetYear,
              isReleased: releaseOffset === 0 ? false : false,
              originalFilmIndex: filmIndex,
              expectedViews: Math.floor(followers * (scriptQuality === "High-Quality" ? 0.25 : 0.15)) // Higher expected views for sequels
            };
            videoLibrary.push(video);

            let outcome = releaseOffset === 0
              ? `🎥 You created sequel "${title}" (${scriptQuality}, ${duration} min, ${scriptGenres.join(", ")}) for "${originalFilm.title}" and stored it in your video library. Expected ~${video.expectedViews.toLocaleString()} views if released.`
              : `🎥 You created sequel "${title}" (${scriptQuality}, ${duration} min, ${scriptGenres.join(", ")}) for "${originalFilm.title}" and scheduled it for release in Year ${targetYear}, Week ${targetWeek}. Expected ~${video.expectedViews.toLocaleString()} views.`;
            await showInfoModal(`🗓️ Week ${week} Action:\n${outcome}`);
            updateStats();
            updateWeekChoices();
            updateLifestyleButtons();
            checkEnergy();
            saveGame();
            resolve(outcome);
          };

          cancelBtn.onclick = () => {
            document.getElementById("modal").style.display = "none";
            modalContent.classList.remove("short-film");
            resolve(null);
          };
        };

        // Handle cancel button for script selection
        document.getElementById("cancelScriptBtn").onclick = () => {
          document.getElementById("modal").style.display = "none";
          modalContent.classList.remove("short-film");
          resolve(null);
        };
      };

      // Handle cancel button for film selection
      document.getElementById("cancelFilmBtn").onclick = () => {
        document.getElementById("modal").style.display = "none";
        modalContent.classList.remove("short-film");
        resolve(null);
      };
    };

    // Function to create a series episode
    window.createSeriesEpisode = async () => {
      document.getElementById("modal").style.display = "none";
      modalContent.classList.remove("short-film");

      // Generate options for released short films
      let filmOptions = videoLibrary
        .map((video, index) => {
          if (video.isReleased && video.type === "Short Film") {
            return `<button class="modal-btn" onclick="selectFilmForSeries(${index})">${video.title} (${video.quality}, ${video.genres.join(", ")})</button>`;
          }
          return "";
        })
        .filter(opt => opt !== "")
        .join("");

      if (filmOptions === "") {
        await showModal("No released short films available for a series. Try another action?");
        resolve(null);
        return;
      }

      // Modal for selecting film
      modalContent.classList.add("short-film");
      modalContent.innerHTML = `
        <h3>Select Film for Series</h3>
        <p>🎥 Choose a released short film for the series:</p>
        <div id="modalButtons" class="modal-buttons">
          ${filmOptions}
          <button class="modal-btn no" id="cancelFilmBtn">Cancel</button>
        </div>
      `;
      document.getElementById("modal").style.display = "flex";

      // Function to handle film selection
      window.selectFilmForSeries = async (filmIndex) => {
        document.getElementById("modal").style.display = "none";
        modalContent.classList.remove("short-film");
        const originalFilm = videoLibrary[filmIndex];

        // Generate script options
        let scriptOptions = scriptQualities
          .map((script, index) => {
            const genresText = script.genres.length > 0 ? script.genres.join(", ") : "General";
            return `<button class="modal-btn" onclick="selectScriptForSeries(${index}, ${filmIndex})">${script.quality} Script (${genresText})</button>`;
          })
          .join("");

        if (scriptOptions === "") {
          await showModal("No scripts available to create a series episode. Try another action?");
          resolve(null);
          return;
        }

        // Modal for selecting script
        modalContent.classList.add("short-film");
        modalContent.innerHTML = `
          <h3>Select Script for Series Episode</h3>
          <p>🎥 Creating episode for "${originalFilm.title}" series (${originalFilm.genres.join(", ")})</p>
          <div id="modalButtons" class="modal-buttons">
            ${scriptOptions}
            <button class="modal-btn no" id="cancelScriptBtn">Cancel</button>
          </div>
        `;
        document.getElementById("modal").style.display = "flex";

        // Function to handle script selection for series
        window.selectScriptForSeries = async (scriptIndex, filmIndex) => {
          document.getElementById("modal").style.display = "none";
          modalContent.classList.remove("short-film");
          const selectedScript = scriptQualities[scriptIndex];
          const scriptQuality = selectedScript.quality;
          const scriptGenres = originalFilm.genres; // Use original film's genres

          // Calculate next episode number
          const existingEpisodes = videoLibrary.filter(v => v.seriesTitle === originalFilm.title && v.type === "Series Episode");
          const episodeNumber = existingEpisodes.length + 1;

          // Modal for entering title, duration, and release week
          modalContent.classList.add("short-film");
          modalContent.innerHTML = `
            <h3>Create Series Episode</h3>
            <p>🎥 Using ${scriptQuality} Script for "${originalFilm.title}" Episode ${episodeNumber} (${scriptGenres.join(", ")})</p>
            <input type="text" id="filmTitle" placeholder="Episode Title (1-50 chars)" maxlength="50" style="width: 100%;">
            <input type="number" id="filmDuration" placeholder="Duration (1-5 min)" min="1" max="5" style="width: 100%;">
            <input type="number" id="releaseWeek" placeholder="Release (1-12 wks, 0 for library)" min="0" max="12" style="width: 100%;">
            <div id="modalButtons" class="modal-buttons">
              <button class="modal-btn yes" id="submitFilmBtn">Submit</button>
              <button class="modal-btn no" id="cancelFilmBtn">Cancel</button>
            </div>
          `;
          document.getElementById("modal").style.display = "flex";

          // Attach event listeners
          const submitBtn = document.getElementById("submitFilmBtn");
          const cancelBtn = document.getElementById("cancelFilmBtn");

          submitBtn.onclick = async () => {
            const title = document.getElementById("filmTitle").value.trim();
            const duration = Number(document.getElementById("filmDuration").value);
            const releaseOffset = Number(document.getElementById("releaseWeek").value);

            // Validate inputs
            if (!title || title.length < 1 || title.length > 50) {
              await showInfoModal("Please enter a valid title (1–50 characters).");
              return;
            }
            if (isNaN(duration) || duration < 1 || duration > 5) {
              await showInfoModal("Please enter a valid duration (1–5 minutes).");
              return;
            }
            if (isNaN(releaseOffset) || releaseOffset < 0 || releaseOffset > 12) {
              await showInfoModal("Please schedule release 0–12 weeks ahead (0 to store in library).");
              return;
            }

            document.getElementById("modal").style.display = "none";
            modalContent.classList.remove("short-film");
            energy -= 30;
            scripts -= 1;
            scriptQualities.splice(scriptIndex, 1); // Remove the selected script

            // Calculate release week and year
            let targetWeek = releaseOffset === 0 ? 0 : week + releaseOffset;
            let targetYear = releaseOffset === 0 ? 0 : year;
            if (targetWeek > 52) {
              targetWeek -= 52;
              targetYear += 1;
            }

            // Store video in library with expected views
            const video = {
              title,
              type: "Series Episode",
              seriesTitle: originalFilm.title,
              episodeNumber,
              genres: scriptGenres,
              quality: scriptQuality,
              duration,
              releaseWeek: targetWeek,
              releaseYear: targetYear,
              isReleased: releaseOffset === 0 ? false : false,
              originalFilmIndex: filmIndex,
              expectedViews: Math.floor(followers * (scriptQuality === "High-Quality" ? 0.22 : 0.12) * (1 + episodeNumber * 0.05)) // Scales with episode number
            };
            videoLibrary.push(video);

            let outcome = releaseOffset === 0
              ? `🎥 You created "${title}" (Episode ${episodeNumber}, ${scriptQuality}, ${duration} min, ${scriptGenres.join(", ")}) for "${originalFilm.title}" series and stored it in your video library. Expected ~${video.expectedViews.toLocaleString()} views if released.`
              : `🎥 You created "${title}" (Episode ${episodeNumber}, ${scriptQuality}, ${duration} min, ${scriptGenres.join(", ")}) for "${originalFilm.title}" series and scheduled it for release in Year ${targetYear}, Week ${targetWeek}. Expected ~${video.expectedViews.toLocaleString()} views.`;
            await showInfoModal(`🗓️ Week ${week} Action:\n${outcome}`);
            updateStats();
            updateWeekChoices();
            updateLifestyleButtons();
            checkEnergy();
            saveGame();
            resolve(outcome);
          };

          cancelBtn.onclick = () => {
            document.getElementById("modal").style.display = "none";
            modalContent.classList.remove("short-film");
            resolve(null);
          };
        };

        // Handle cancel button for script selection
        document.getElementById("cancelScriptBtn").onclick = () => {
          document.getElementById("modal").style.display = "none";
          modalContent.classList.remove("short-film");
          resolve(null);
        };
      };

      // Handle cancel button for film selection
      document.getElementById("cancelFilmBtn").onclick = () => {
        document.getElementById("modal").style.display = "none";
        modalContent.classList.remove("short-film");
        resolve(null);
      };
    };
  });
}

async function scheduleVideoRelease() {
  if (followers < 10000) {
    await showModal("You need at least 10,000 Followers to release a video on TikTok for meaningful impact. Try another action?");
    return;
  }

  // Generate options for unreleased videos
  let videoOptions = videoLibrary
    .map((video, index) => {
      if (!video.isReleased && video.releaseWeek === 0) {
        const titleText = video.type === "Series Episode"
          ? `"${video.title}" (Episode ${video.episodeNumber} of "${video.seriesTitle}")`
          : `"${video.title}" (${video.type})`;
        return `<button class="modal-btn" onclick="selectVideoToRelease(${index})">${titleText} (${video.quality}, ${video.genres.join(", ")})</button>`;
      }
      return "";
    })
    .filter(opt => opt !== "")
    .join("");

  if (videoOptions === "") {
    await showModal("No unreleased videos available in your library to schedule for release. Try creating a new video?");
    return;
  }

  // Create a modal for selecting a video to release
  return new Promise((resolve) => {
    const modalContent = document.querySelector(".modal-content");
    modalContent.classList.add("short-film");
    modalContent.innerHTML = `
      <h3>Schedule Video Release</h3>
      <p>🎥 Choose a video to schedule for release:</p>
      <div id="modalButtons" class="modal-buttons">
        ${videoOptions}
        <button class="modal-btn no" id="cancelVideoBtn">Cancel</button>
      </div>
    `;
    document.getElementById("modal").style.display = "flex";

    // Function to handle video selection
    window.selectVideoToRelease = async (index) => {
      document.getElementById("modal").style.display = "none";
      modalContent.classList.remove("short-film");
      const selectedVideo = videoLibrary[index];

      // Modal for entering release week
      modalContent.classList.add("short-film");
      modalContent.innerHTML = `
        <h3>Schedule Release</h3>
        <p>🎥 Scheduling "${selectedVideo.title}" (${selectedVideo.type}, ${selectedVideo.quality}, ${selectedVideo.genres.join(", ")})</p>
        <input type="number" id="releaseWeek" placeholder="Release (1-12 wks)" min="1" max="12" style="width: 100%;">
        <div id="modalButtons" class="modal-buttons">
          <button class="modal-btn yes" id="submitReleaseBtn">Submit</button>
          <button class="modal-btn no" id="cancelReleaseBtn">Cancel</button>
        </div>
      `;
      document.getElementById("modal").style.display = "flex";

      // Attach event listeners
      const submitBtn = document.getElementById("submitReleaseBtn");
      const cancelBtn = document.getElementById("cancelReleaseBtn");

      submitBtn.onclick = async () => {
        const releaseOffset = Number(document.getElementById("releaseWeek").value);

        // Validate input
        if (isNaN(releaseOffset) || releaseOffset < 1 || releaseOffset > 12) {
          await showInfoModal("Please schedule release 1–12 weeks ahead.");
          return;
        }

        document.getElementById("modal").style.display = "none";
        modalContent.classList.remove("short-film");

        // Calculate release week and year
        let targetWeek = week + releaseOffset;
        let targetYear = year;
        if (targetWeek > 52) {
          targetWeek -= 52;
          targetYear += 1;
        }

        // Update video in library
        videoLibrary[index].releaseWeek = targetWeek;
        videoLibrary[index].releaseYear = targetYear;

        let titleText = selectedVideo.type === "Series Episode"
          ? `"${selectedVideo.title}" (Episode ${selectedVideo.episodeNumber} of "${selectedVideo.seriesTitle}")`
          : `"${selectedVideo.title}" (${selectedVideo.type})`;
        let outcome = `🎥 You scheduled ${titleText} (${selectedVideo.quality}, ${selectedVideo.duration} min, ${selectedVideo.genres.join(", ")}) for release in Year ${targetYear}, Week ${targetWeek}.`;
        await showInfoModal(`🗓️ Week ${week} Action:\n${outcome}`);
        updateStats();
        updateWeekChoices();
        updateLifestyleButtons();
        checkEnergy();
        saveGame();
        resolve(outcome);
      };

      cancelBtn.onclick = () => {
        document.getElementById("modal").style.display = "none";
        modalContent.classList.remove("short-film");
        resolve(null);
      };
    };

    // Handle cancel button for video selection
    document.getElementById("cancelVideoBtn").onclick = () => {
      document.getElementById("modal").style.display = "none";
      modalContent.classList.remove("short-film");
      resolve(null);
    };
  });
}

async function getMarried() {
  if (isMarried) {
    await showInfoModal("You are already married!");
    return;
  }
  if (age < 20) {
    await showInfoModal("You must be at least 20 years old to get married. Try another action?");
    return;
  }
  if (money < 10000) {
    await showInfoModal(`Not enough money to get married (${currencySymbol}10,000 required). Try another action?`);
    return;
  }
  if (fame < 20) {
    await showInfoModal("You need at least 20 Fame to attract a partner for marriage. Try another action?");
    return;
  }
  if (energy < 30) {
    await showInfoModal("Not enough energy to get married. Try another action?");
    return;
  }

  const spouseNames = [
    "Emma Watson", "Sofia Vergara", "Zendaya Coleman", "Priyanka Chopra", "Margot Robbie",
    "Gal Gadot", "Scarlett Johansson", "Natalie Portman", "Jennifer Lawrence", "Deepika Padukone"
  ];
  spouseName = spouseNames[Math.floor(Math.random() * spouseNames.length)];
  isMarried = true;
  money -= convertCurrency(10000);
  fame += 0.5;
  followers += 100;
  energy -= 30;

  const outcome = `💍 Congratulations! You married ${spouseName}! +0.5 Fame, +100 Followers`;
  await showInfoModal(`🗓️ Week ${week} Action:\n${outcome}`);
  fame = Math.floor(fame || 1);
  updateStats();
  updateLifestyleButtons();
  checkEnergy();
  saveGame();
}

    async function randomEvent() {
  if (fame < 10 && blockbusters === 0) return; // No events for very low fame and no blockbusters

  // Define event pools by fame level
  const lowFameEvents = [
    { type: "positive", message: "🎤 A casting assistant praised your recent audition on a local blog! +15 Followers", effect: () => { if (actionUses.audition > 0) { followers += 15; return true; } return false; } },
    { type: "positive", message: "📲 Your TikTok monologue got shared by a local theater group! +0.01 Fame, +10 Followers", effect: () => { if (actionUses.tiktok > 0) { fame += 0.01; followers += 10; return true; } return false; } },
    { type: "negative", message: "📱 An old embarrassing clip resurfaces! -10 Fame", effect: () => { fame = Math.max(fame - 10, 1); return true; } },
    { type: "positive", message: "📺 A local business offers you a role in a low-budget commercial! +$200, +0.1 Fame", effect: () => { money += convertCurrency(200); fame += 0.1; return true; } },
    { type: "positive", message: "📬 You receive heartfelt fan mail from a small group of supporters! +10 Followers, +5 Energy", effect: () => { if (actionUses.audition > 0) { followers += 10; energy = Math.min(energy + 5, 100); return true; } return false; } },
    { type: "negative", message: "😕 A casting director sends you a polite rejection email. -5 Energy", effect: () => { if (actionUses.audition > 0) { energy = Math.max(energy - 5, 0); return true; } return false; } },
    { type: "negative", message: "💸 Your headshot photographer raises their fee! -$150", effect: () => { if (money >= convertCurrency(150)) { money -= convertCurrency(150); return true; } return false; } },
    // New low fame events
    { type: "positive", message: "🇳🇬 A Nollywood producer notices your audition at a Lagos casting call! +0.1 Fame, +20 Followers", effect: () => { if (actionUses.audition > 0) { fame += 0.1; followers += 20; return true; } return false; } },
    { type: "positive", message: "🎥 Your short film is screened at a community event in Abuja! +10 Followers, +5 Energy", effect: () => { if (scheduledShortFilms.length > 0) { followers += 10; energy = Math.min(energy + 5, 100); return true; } return false; } },
    { type: "negative", message: "📽️ A local film festival in Enugu rejects your submission. -5 Energy", effect: () => { if (scheduledShortFilms.length > 0 || scripts > 0) { energy = Math.max(energy - 5, 0); return true; } return false; } },
    { type: "positive", message: "🌍 An indie director from London spots your TikTok clip! +0.05 Fame, +15 Followers", effect: () => { if (actionUses.tiktok > 0) { fame += 0.05; followers += 15; return true; } return false; } }
  ];

  const midFameEvents = [
    { type: "positive", message: "🤝 Your agent got your name in a casting call memo! +0.2 Fame, +20 Followers", effect: () => { if (hasAgent) { fame += 0.2; followers += 20; return true; } return false; } },
    { type: "positive", message: "📜 A director commented on your script at a panel! +$100", effect: () => { if (scripts > 0) { money += convertCurrency(100); return true; } return false; } },
    { type: "positive", message: "🥂 You were spotted at an A-List party by a gossip vlogger! +0.15 Fame, +25 Followers", effect: () => { if (actionUses.aListParty > 0) { fame += 0.15; followers += 25; return true; } return false; } },
    { type: "positive", message: "🎮 Your video game voice clip was shared by a gaming blog! +30 Followers", effect: () => { if (actionUses.voiceAct > 0) { followers += 30; return true; } return false; } },
    { type: "negative", message: "📰 A critic panned a recent role in a blog post. -0.1 Fame", effect: () => { fame = Math.max(fame - 0.1, 1); return true; } },
    { type: "positive", message: "📸 You get invited to a red-carpet event! +5 Fame, -$300 (outfit cost)", effect: () => { if (money >= convertCurrency(300)) { fame += 5; money -= convertCurrency(300); return true; } return false; } },
    { type: "negative", message: "📸 A gossip blog posts about you! +2 Fame, -50 Followers", effect: () => { fame += 2; followers = Math.max(followers - 50, 0); return true; } },
    { type: "positive", message: "📸 Paparazzi catch you leaving the gym! +1 Fame, +20 Followers", effect: () => { fame += 1; followers += 20; return true; } },
    { type: "positive", message: "📸 A meme of your audition face goes viral! +3 Fame, +1000 Followers", effect: () => { if (actionUses.audition > 0) { fame += 3; followers += 1000; return true; } return false; } },
    { type: "positive", message: "🎭 A famous actor gives you advice! +2 Skill XP, +2 Fame", effect: () => { practiceXP += 2; skill = getSkillByXP(practiceXP); fame += 2; return true; } },
    { type: "negative", message: "🎭 Casting director ignores you! -50 Followers", effect: () => { if (actionUses.audition > 0) { followers = Math.max(followers - 50, 0); return true; } return false; } },
    { type: "positive", message: "🎭 You get a callback! Chance for role next week", effect: () => { if (actionUses.audition > 0) { actionAvailability.blockbuster = true; return true; } return false; } },
    { type: "negative", message: "🎭 You get typecast in comedy roles! +3 Fame, but Skill growth slows", effect: () => { fame += 3; practiceXP = Math.max(practiceXP - 1, 0); skill = getSkillByXP(practiceXP); return true; } },
    { type: "negative", message: "🎭 You freeze on stage! -1 Skill XP", effect: () => { if (actionUses.audition > 0) { practiceXP = Math.max(practiceXP - 1, 0); skill = getSkillByXP(practiceXP); return true; } return false; } },
    { type: "positive", message: "🎭 You improvise and impress the crowd! +3 Skill XP", effect: () => { if (actionUses.audition > 0) { practiceXP += 3; skill = getSkillByXP(practiceXP); return true; } return false; } },
    { type: "positive", message: "📱 You collab with a micro-influencer! +200 Followers", effect: () => { if (actionUses.tiktok > 0) { followers += 200; return true; } return false; } },
    { type: "positive", message: "📱 You stream live and engage! +2 Fame, +300 Followers", effect: () => { if (actionUses.tiktok > 0) { fame += 2; followers += 300; return true; } return false; } },
    { type: "negative", message: "📱 Trolls harass you! -200 Followers", effect: () => { if (actionUses.tiktok > 0) { followers = Math.max(followers - 200, 0); return true; } return false; } },
    { type: "positive", message: "🤝 You meet a producer at a party! +2 Fame", effect: () => { if (actionUses.aListParty > 0) { fame += 2; return true; } return false; } },
    { type: "positive", message: "🤝 A friend introduces you to an agent! Audition chance unlocked", effect: () => { if (!hasAgent) { hasAgent = true; return true; } return false; } },
    { type: "negative", message: "🤝 You argue with a co-star! -1 Fame", effect: () => { if (blockbusters > 0) { fame = Math.max(fame - 1, 1); return true; } return false; } },
    { type: "positive", message: "🤝 You mentor a younger actor! +1 Skill XP", effect: () => { practiceXP += 1; skill = getSkillByXP(practiceXP); return true; } },
    { type: "negative", message: "🤝 Rival actor trashes you publicly! -2 Fame", effect: () => { fame = Math.max(fame - 2, 1); return true; } },
    { type: "positive", message: "⚡ A fan meetup drains you! +200 Followers, -20 Energy", effect: () => { followers += 200; energy = Math.max(energy - 20, 0); return true; } },
    { type: "negative", message: "⚡ You burn out! -1 Skill XP, -20 Energy", effect: () => { practiceXP = Math.max(practiceXP - 1, 0); skill = getSkillByXP(practiceXP); energy = Math.max(energy - 20, 0); return true; } },
    { type: "positive", message: "🤝 You're invited to speak at a charity event! +0.3 Fame, +50 Followers, -$500", effect: () => { if (money >= convertCurrency(500)) { fame += 0.3; followers += 50; money -= convertCurrency(500); return true; } return false; } },
    { type: "negative", message: "📱 You accidentally post a controversial opinion online! -0.2 Fame, -100 Followers", effect: () => { if (actionUses.tiktok > 0) { fame = Math.max(fame - 0.2, 1); followers = Math.max(followers - 100, 0); return true; } return false; } },
    { type: "positive", message: "📜 A writer friend invites you to a script reading workshop! +1 Skill XP, -10 Energy", effect: () => { if (scripts > 0) { practiceXP += 1; skill = getSkillByXP(practiceXP); energy = Math.max(energy - 10, 0); return true; } return false; } },
    { type: "positive", message: "?? Paparazzi snap you at a coffee shop! +0.2 Fame, +25 Followers", effect: () => { fame += 0.2; followers += 25; return true; } },
    // New mid fame events
    { type: "positive", message: "🇳🇬 You collaborate with a Nollywood star like Genevieve Nnaji on a short film! +0.3 Fame, +50 Followers", effect: () => { if (scheduledShortFilms.length > 0) { fame += 0.3; followers += 50; return true; } return false; } },
    { type: "positive", message: "🌍 A Hollywood casting director sees your work at the AMAA! +0.4 Fame, +100 Followers", effect: () => { fame += 0.4; followers += 100; return true; } },
    { type: "negative", message: "📰 A Lagos tabloid publishes a false rumor about your work ethic! -0.2 Fame, -50 Followers", effect: () => { fame = Math.max(fame - 0.2, 1); followers = Math.max(followers - 50, 0); return true; } },
    { type: "positive", message: "🎥 Your script is optioned by a Nigerian production company! +$1000, +0.2 Fame", effect: () => { if (scripts > 0) { money += convertCurrency(1000); fame += 0.2; return true; } return false; } },
    { type: "positive", message: "🇳🇬 Your role in a Nollywood film gets praise at the Zuma Film Festival! +0.3 Fame, +75 Followers", effect: () => { if (blockbusters > 0) { fame += 0.3; followers += 75; return true; } return false; } },
    { type: "negative", message: "🎬 A director in Los Angeles drops you from a project due to scheduling conflicts. -0.1 Fame, -20 Energy", effect: () => { if (actionUses.audition > 0) { fame = Math.max(fame - 0.1, 1); energy = Math.max(energy - 20, 0); return true; } return false; } }
  ];

  const highFameEvents = [
    { type: "positive", message: "🎬 Your blockbuster scene was featured in a viral trailer! +0.25 Fame, +75 Followers", effect: () => { if (blockbusters > 0) { fame += 0.25; followers += 75; return true; } return false; } },
    { type: "positive", message: "📺 Your endorsement ad was highlighted in a marketing recap! +$150, +0.15 Fame", effect: () => { if (actionUses.endorsement > 0) { money += convertCurrency(150); fame += 0.15; return true; } return false; } },
    { type: "positive", message: "🎥 Your movie got a shoutout at a film festival! +0.3 Fame", effect: () => { if (producedMovies > 0) { fame += 0.3; return true; } return false; } },
    { type: "positive", message: "🛍️ A celebrity wore your merch on a talk show! +0.2 Fame, +40 Followers", effect: () => { if (actionUses.merchLine > 0) { fame += 0.2; followers += 40; return true; } return false; } },
    { type: "negative", message: "😱 A tabloid misquoted you, sparking a minor controversy! -0.15 Fame", effect: () => { fame = Math.max(fame - 0.15, 1); return true; } },
    { type: "positive", message: "🎬 You land a supporting role! +5 Fame, +$3000", effect: () => { fame += 5; money += convertCurrency(3000); return true; } },
    { type: "positive", message: "🎬 Your indie film gets into a festival! +10 Fame", effect: () => { if (blockbusters > 0) { fame += 10; return true; } return false; } },
    { type: "positive", message: "📱 A blockbuster director follows you on IG! +1000 Followers", effect: () => { if (blockbusters > 0) { followers += 1000; return true; } return false; } },
    { type: "positive", message: "🏆 You win a small award! +7 Fame", effect: () => { fame += 7; return true; } },
    { type: "negative", message: "🎬 You lose a role to a rival! -2 Fame", effect: () => { fame = Math.max(fame - 2, 1); return true; } },
    { type: "positive", message: "📜 Your script gets optioned! +$5000, +5 Fame", effect: () => { if (scripts > 0) { money += convertCurrency(5000); fame += 5; return true; } return false; } },
    { type: "negative", message: "🤝 Your agent drops you! -5 Fame", effect: () => { if (hasAgent) { hasAgent = false; fame = Math.max(fame - 5, 1); return true; } return false; } },
    { type: "positive", message: "📺 Your commercial goes viral! +8 Fame", effect: () => { fame += 8; return true; } },
    { type: "positive", message: "📺 A talk show invites you as a guest! +12 Fame", effect: () => { fame += 12; return true; } },
    { type: "negative", message: "🎬 You bomb an audition for a big role! -5 Fame", effect: () => { if (actionUses.audition > 0) { fame = Math.max(fame - 5, 1); return true; } return false; } },
    { type: "positive", message: "📱 A celebrity likes your post! +1000 Followers, +5 Fame", effect: () => { if (actionUses.tiktok > 0) { followers += 1000; fame += 5; return true; } return false; } },
    { type: "negative", message: "📱 Your content gets stolen! -1 Fame", effect: () => { if (actionUses.tiktok > 0) { fame = Math.max(fame - 1, 1); return true; } return false; } },
    { type: "positive", message: "🤝 You attend a networking mixer! +2 Fame, +100 Followers", effect: () => { if (actionUses.networking > 0) { fame += 2; followers += 100; return true; } return false; } },
    { type: "negative", message: "🤝 You party too hard! -1 Skill XP, -$200", effect: () => { if (actionUses.aListParty > 0) { practiceXP = Math.max(practiceXP - 1, 0); skill = getSkillByXP(practiceXP); money -= convertCurrency(200); return true; } return false; } },
    { type: "positive", message: "🤝 You get invited to a director’s private screening! +4 Fame", effect: () => { fame += 4; return true; } },
    { type: "positive", message: "🎉 You trend on TikTok for dancing badly! +2000 Followers, +2 Fame", effect: () => { if (actionUses.tiktok > 0) { followers += 2000; fame += 2; return true; } return false; } },
    { type: "positive", message: "🎉 A director randomly calls you! Instant audition chance", effect: () => { actionAvailability.blockbuster = true; return true; } },
    { type: "negative", message: "🎉 You get into a scandal! -10 Fame, -500 Followers", effect: () => { fame = Math.max(fame - 10, 1); followers = Math.max(followers - 500, 0); return true; } },
    { type: "positive", message: "🎉 You save a dog on set! +3 Fame, +300 Followers", effect: () => { if (blockbusters > 0) { fame += 3; followers += 300; return true; } return false; } },
    { type: "positive", message: "🎉 A fan spots you at the mall! +50 Followers", effect: () => { followers += 50; return true; } },
    { type: "positive", message: "🎉 You go viral for clapping off-beat! +500 Followers", effect: () => { if (actionUses.tiktok > 0) { followers += 500; return true; } return false; } },
    { type: "negative", message: "🎉 Someone leaks your audition tape! +2 Fame, -1 Skill XP", effect: () => { if (actionUses.audition > 0) { fame += 2; practiceXP = Math.max(practiceXP - 1, 0); skill = getSkillByXP(practiceXP); return true; } return false; } },
    { type: "positive", message: "🎉 You get recognized in public! +1 Fame", effect: () => { fame += 1; return true; } },
    { type: "positive", message: "🎉 Your Uber driver is a producer! Audition unlocked", effect: () => { actionAvailability.blockbuster = true; return true; } },
    { type: "positive", message: "🎉 You star in a meme trend! +5 Fame, +1000 Followers", effect: () => { fame += 5; followers += 1000; return true; } },
    { type: "positive", message: "🎉 You cameo in a music video! +4 Fame, +$1000", effect: () => { fame += 4; money += convertCurrency(1000); return true; } },
    { type: "positive", message: "🎉 A scandal fades away! +3 Fame", effect: () => { fame += 3; return true; } },
    { type: "positive", message: "🎉 You save money on rent by moving in with roommates! +$1000, -5 Energy weekly", effect: () => { money += convertCurrency(1000); energy = Math.max(energy - 5, 0); return true; } },
    { type: "positive", message: "🎉 Someone cosplays as you! +3 Fame", effect: () => { fame += 3; return true; } },
    { type: "positive", message: "🎉 Your autograph sells online! +$200, +1 Fame", effect: () => { money += convertCurrency(200); fame += 1; return true; } },
    { type: "positive", message: "📺 A late-night talk show invites you for an interview! +1 Fame, +200 Followers, -$1000", effect: () => { if (money >= convertCurrency(1000)) { fame += 1; followers += 200; money -= convertCurrency(1000); return true; } return false; } },
    { type: "negative", message: "😱 Fans criticize your recent role for being 'out of touch'! -0.5 Fame, -150 Followers", effect: () => { if (blockbusters > 0) { fame = Math.max(fame - 0.5, 1); followers = Math.max(followers - 150, 0); return true; } return false; } },
    { type: "negative", message: "🏆 You were expected to be nominated for an award but got snubbed! -0.3 Fame", effect: () => { if (blockbusters >= 5) { fame = Math.max(fame - 0.3, 1); return true; } return false; } },
    { type: "positive", message: "📺 A brand offers to renew your endorsement deal! +$5000, +0.4 Fame", effect: () => { if (actionUses.endorsement > 0) { money += convertCurrency(5000); fame += 0.4; return true; } return false; } },
    // New high fame events
    { type: "positive", message: "🌍 You’re invited to co-star with Lupita Nyong'o in a Hollywood-Nollywood crossover film! +1 Fame, +200 Followers, +$5000", effect: () => { if (blockbusters > 0) { fame += 1; followers += 200; money += convertCurrency(5000); return true; } return false; } },
    { type: "positive", message: "🇳🇬 Your film wins a special mention at the Africa International Film Festival (AFRIFF)! +0.5 Fame, +150 Followers", effect: () => { if (producedMovies > 0 || blockbusters > 0) { fame += 0.5; followers += 150; return true; } return false; } },
    { type: "negative", message: "😱 A global media outlet misrepresents your comments about Nollywood, causing backlash! -0.5 Fame, -200 Followers", effect: () => { fame = Math.max(fame - 0.5, 1); followers = Math.max(followers - 200, 0); return true; } },
    { type: "positive", message: "🎬 You’re invited to a private screening with a Cannes Film Festival jury member! +0.6 Fame, +100 Followers", effect: () => { fame += 0.6; followers += 100; return true; } },
    { type: "positive", message: "🇳🇬 A Nigerian director like Kunle Afolayan praises your work in a Vanguard interview! +0.4 Fame, +120 Followers", effect: () => { if (blockbusters > 0) { fame += 0.4; followers += 120; return true; } return false; } },
    { type: "negative", message: "🎥 A producer in Hollywood accuses you of being difficult on set! -0.3 Fame, -100 Followers", effect: () => { if (blockbusters > 0) { fame = Math.max(fame - 0.3, 1); followers = Math.max(followers - 100, 0); return true; } return false; } },
    { type: "positive", message: "🌍 You’re cast in a Netflix series shooting in Lagos and Los Angeles! +1.5 Fame, +$10000, +300 Followers", effect: () => { if (fame >= 60) { fame += 1.5; money += convertCurrency(10000); followers += 300; return true; } return false; } }
  ];

  let eventPool = lowFameEvents;
  let eventChance = 0.15; // Base chance for low fame

  if (fame >= 30 && fame < 60) {
    eventPool = [...lowFameEvents, ...midFameEvents];
    eventChance = 0.2; // Increased chance for mid fame
  } else if (fame >= 60) {
    eventPool = [...lowFameEvents, ...midFameEvents, ...highFameEvents];
    eventChance = 0.25; // Higher chance for high fame
  }

  if (Math.random() > eventChance) return; // Only trigger if random < eventChance

  const validEvents = eventPool.filter(event => event.effect() !== false);
  if (validEvents.length === 0) return;
  const event = validEvents[Math.floor(Math.random() * validEvents.length)];
  event.effect();
  await showInfoModal(`Random Event: ${event.message}`);
  fame = Math.floor(fame || 1); // Ensure fame doesn't drop below 1
  updateStats();
  saveGame();
}

    async function nextWeek() {
  week++;

  // Reset action uses annually
  if (week > 52) {
    week = 1;
    year += 1;
    age += 1;
    actionUses = {
      writeScript: 0,
      blockbuster: 0,
      aListParty: 0,
      voiceAct: 0,
      endorsement: 0,
      networking: 0,
      merchLine: 0,
      produceMovie: 0
    };
    await showInfoModal(`🎉 Happy New Year! You are now ${age} years old, starting Year ${year}.`);
  }

  if (age >= 70) {
    await showInfoModal("🎭 You've reached age 70. It's time to retire from your acting career. Thank you for an incredible journey!");
    resetGame();
    return;
  }

  hasAgent = false;
  energy = 100;
  document.getElementById("weekNum").textContent = `Year ${year}, Week ${week}`;
  document.getElementById("log").innerHTML = "";

  // Decrement cooldowns
  for (let action in actionCooldowns) {
    if (actionCooldowns[action] > 0) {
      actionCooldowns[action]--;
    }
  }

  // Update action availability based on fame and random chance
  actionAvailability.writeScript = actionCooldowns.writeScript === 0 && actionUses.writeScript < MAX_ACTION_USES_PER_YEAR.writeScript && practiceXP >= 7;
  actionAvailability.blockbuster = actionCooldowns.blockbuster === 0 && actionUses.blockbuster < MAX_ACTION_USES_PER_YEAR.blockbuster && fame >= 45 && Math.random() < 0.2;
  actionAvailability.aListParty = actionCooldowns.aListParty === 0 && actionUses.aListParty < MAX_ACTION_USES_PER_YEAR.aListParty && fame >= 20 && Math.random() < 0.3;
  actionAvailability.voiceAct = actionCooldowns.voiceAct === 0 && actionUses.voiceAct < MAX_ACTION_USES_PER_YEAR.voiceAct && fame >= 15 && Math.random() < 0.35;
  actionAvailability.endorsement = actionCooldowns.endorsement === 0 && actionUses.endorsement < MAX_ACTION_USES_PER_YEAR.endorsement && fame >= 30 && Math.random() < 0.3;
  actionAvailability.networking = actionCooldowns.networking === 0 && actionUses.networking < MAX_ACTION_USES_PER_YEAR.networking && fame >= 25 && practiceXP >= 20 && Math.random() < 0.3;
  actionAvailability.merchLine = actionCooldowns.merchLine === 0 && actionUses.merchLine < MAX_ACTION_USES_PER_YEAR.merchLine && fame >= 35 && followers >= 500 && Math.random() < 0.25;
  actionAvailability.produceMovie = actionCooldowns.produceMovie === 0 && actionUses.produceMovie < MAX_ACTION_USES_PER_YEAR.produceMovie && fame >= 10;

  if (isMarried && Math.random() < 0.05) {
    const divorceAmount = Math.floor(money / 2);
    money -= divorceAmount;
    fame = Math.max(fame - 0.5, 1);
    await showInfoModal(`💔 ${spouseName} has filed for divorce and taken ${currencySymbol}${formatMoney(divorceAmount)} of your assets! -0.5 Fame`);
    isMarried = false;
    spouseName = "";
    updateStats();
    updateLifestyleButtons();
  }

  if (voiceActingWeeks > 0) {
    money += voiceActingIncome;
    voiceActingWeeks--;
    await showInfoModal(`💸 Received ${currencySymbol}${voiceActingIncome} from video game voice acting. ${voiceActingWeeks} weeks remaining.`);
    updateStats();
  }

  if (merchWeeks > 0 && !merchFailed) {
    money += merchIncome;
    if (Math.random() < 0.02) {
      merchFailed = true;
      merchIncome = 0;
      merchWeeks = 0;
      await showInfoModal(`😕 Your merchandise line crashed due to market trends or a scandal! Income stopped.`);
    } else {
      await showInfoModal(`💸 Received ${currencySymbol}${merchIncome} from merchandise sales.`);
    }
    updateStats();
  }

  if (tiktokMonetizationWeeks > 0) {
    money += tiktokIncome;
    tiktokMonetizationWeeks--;
    await showInfoModal(`💸 Received ${currencySymbol}${tiktokIncome} from TikTok Creator Fund. ${tiktokMonetizationWeeks} weeks remaining.`);
    updateStats();
  }

  if (movieRoyaltyWeeks > 0 && producedMovies > 0) {
    const royaltyPerMovie = convertCurrency(500 + fame * 50);
    const totalRoyalty = royaltyPerMovie * producedMovies;
    money += totalRoyalty;
    movieRoyaltyWeeks--;
    await showInfoModal(`💸 Received ${currencySymbol}${formatMoney(totalRoyalty)} in royalties from ${producedMovies} produced movie${producedMovies > 1 ? 's' : ''}. ${movieRoyaltyWeeks} weeks remaining.`);
    updateStats();
  }

  // Process scheduled video releases
  const videosToRelease = videoLibrary.filter(v => !v.isReleased && v.releaseWeek === week && v.releaseYear === year);
  if (videosToRelease.length > 0) {
    for (const video of videosToRelease) {
      // Calculate views based on followers, fame, quality, duration, and genres
      let baseViews = video.expectedViews || Math.floor(followers * (video.quality === "High-Quality" ? 0.2 : 0.1));
      let durationMultiplier = Math.min(video.duration * 0.1 + 0.8, 1.5); // 1-5 min gives 0.9-1.3 multiplier
      let genreMultiplier = video.genres.length > 0
        ? video.genres.reduce((sum, genreName) => {
            const genre = genres.find(g => g.name === genreName) || { qualityMultiplier: 1 };
            return sum + genre.qualityMultiplier;
          }, 0) / video.genres.length
        : 1;
      let fameMultiplier = Math.min(1 + fame * 0.01, 2); // Fame up to 100 doubles views
      let skillMultiplier = Math.min(1 + practiceXP * 0.005, 1.5); // Skill up to 100 gives 50% boost
      let viralityChance = Math.min((fame * 0.005 + followers / 100000 + practiceXP * 0.005), 0.6);

      // Adjust for sequels and series episodes
      let typeMultiplier = video.type === "Sequel" ? 1.3 : video.type === "Series Episode" ? (1.1 + video.episodeNumber * 0.05) : 1;
      viralityChance = Math.min(viralityChance * (video.type === "Sequel" ? 1.2 : video.type === "Series Episode" ? (1 + video.episodeNumber * 0.05) : 1), 0.7);

      // Calculate final views
      let views = Math.floor(baseViews * durationMultiplier * genreMultiplier * fameMultiplier * skillMultiplier * typeMultiplier);
      views = Math.max(views, 100); // Minimum views for realism

      // Calculate fame and follower gains based on views
      let baseFameGain = video.quality === "High-Quality" ? 0.5 : 0.2; // Increased base fame
      let followerGain = Math.floor(views * (video.quality === "High-Quality" ? 0.05 : 0.03)); // 3-5% of views convert to followers
      let fameGain = baseFameGain * durationMultiplier * genreMultiplier * typeMultiplier;

      // Calculate money gain (all videos earn some money)
      let monetizationRate = isTikTokMonetized ? (video.quality === "High-Quality" ? 4 : 2) : (video.quality === "High-Quality" ? 2 : 1); // $ per 1,000 views
      let moneyGain = convertCurrency(Math.floor((views / 1000) * monetizationRate));
      moneyGain = Math.max(moneyGain, convertCurrency(10)); // Minimum earnings

      // Handle viral videos
      let isViral = Math.random() < viralityChance;
      let outcome = "";
      let titleText = video.type === "Series Episode"
        ? `"${video.title}" (Episode ${video.episodeNumber} of "${video.seriesTitle}")`
        : `"${video.title}" (${video.type})`;

      if (isViral) {
        views *= 3; // Viral videos get triple views
        fameGain *= 2; // Double fame for viral
        followerGain *= 2; // Double followers for viral
        moneyGain *= 2; // Double money for viral
        if (fame >= 50 && Math.random() < 0.3) { // Sponsorship chance for high-fame players
          let sponsorshipBonus = convertCurrency(Math.floor(1000 + fame * 50));
          moneyGain += sponsorshipBonus;
          outcome = `📈 Your ${video.type.toLowerCase()} ${titleText} (${video.quality}, ${video.duration} min, ${video.genres.join(", ")}) exploded on TikTok with ${views.toLocaleString()} views! It went viral! +${fameGain.toFixed(2)} Fame, +${followerGain.toLocaleString()} Followers, +${currencySymbol}${formatMoney(moneyGain)} (including ${currencySymbol}${formatMoney(sponsorshipBonus)} from a sponsor).`;
        } else {
          outcome = `📈 Your ${video.type.toLowerCase()} ${titleText} (${video.quality}, ${video.duration} min, ${video.genres.join(", ")}) exploded on TikTok with ${views.toLocaleString()} views! It went viral! +${fameGain.toFixed(2)} Fame, +${followerGain.toLocaleString()} Followers, +${currencySymbol}${formatMoney(moneyGain)}.`;
        }
        await generateFollowerReaction(true);
      } else {
        outcome = `📱 Your ${video.type.toLowerCase()} ${titleText} (${video.quality}, ${video.duration} min, ${video.genres.join(", ")}) got ${views.toLocaleString()} views on TikTok. +${fameGain.toFixed(2)} Fame, +${followerGain.toLocaleString()} Followers, +${currencySymbol}${formatMoney(moneyGain)}.`;
        await generateFollowerReaction(false);
      }

      // Cap gains for balance
      fameGain = Math.min(fameGain, fame < 20 ? 1 : fame < 50 ? 2 : 3);
      followerGain = Math.min(followerGain, fame < 20 ? 500 : fame < 50 ? 1000 : 5000);
      moneyGain = Math.min(moneyGain, convertCurrency(fame < 20 ? 500 : fame < 50 ? 2000 : 5000));

      fame += fameGain;
      followers += followerGain;
      money += moneyGain;

      // Mark video as released
      videoLibrary[videoLibrary.indexOf(video)].isReleased = true;

      await showInfoModal(`🗓️ Week ${week} Action:\n${outcome}`);
      fame = Math.floor(fame || 1);
      updateStats();
      updateWeekChoices();
      updateLifestyleButtons();
      checkEnergy();
      saveGame();
    }
  }

  await randomEvent();

  const awardCycle = Math.floor(Math.random() * 3) + 10;
  if (week % awardCycle === 0) {
    await checkAwardShows();
  }

  let offerChance = Math.min(0.05 + ((fame || 1) / 100) * 0.2, 0.3);
  if (Math.random() < offerChance && fame >= 45) {
    let movieReward = 2000 + ((fame || 1) * 100);
    let accept = await showModal(`🎥 You've been offered a blockbuster movie role! Accept? (+${currencySymbol}${movieReward}, +1 Fame, +1 Blockbuster, -50⚡)`);
    if (accept && energy >= 50) {
      energy -= 50;
      money += movieReward;
      fame += 1;
      blockbusters += 1;
      actionCooldowns.blockbuster = 26;
      actionUses.blockbuster++;
      actionAvailability.blockbuster = false;
      let { review, fameChange } = generateReview(true, movieReward);
      await showInfoModal(`${review} (${fameChange >= 0 ? '+' : ''}${fameChange} Fame)`);
      fame = Math.max(fame + fameChange, 1);
      await showInfoModal(`🎬 You starred in a blockbuster movie! Earned ${currencySymbol}${movieReward}, +1 Fame, +1 Blockbuster.`);
      await generateFollowerReaction(true, true);
      fame = Math.floor(fame || 1);
      updateStats();
    } else if (accept && energy < 50) {
      await showModal("😕 Not enough energy to take the blockbuster movie role. Try another action?");
    } else {
      await showInfoModal("🙅 You declined the blockbuster movie role offer.");
    }
  }

  enableButtons();
  updateStats();
  updateLifestyleButtons();
  checkEnergy();
  saveGame();
}


    async function checkAwardShows() {
  const awards = [
    { name: "AMVCA", fameMin: 15, blockbustersMin: 2, fameRewardWin: 2, moneyRewardWin: 5000, fameRewardNom: 0.5 },
    { name: "NEA", fameMin: 15, blockbustersMin: 2, fameRewardWin: 2, moneyRewardWin: 5000, fameRewardNom: 0.5 },
    { name: "BON Awards", fameMin: 15, blockbustersMin: 2, fameRewardWin: 2, moneyRewardWin: 5000, fameRewardNom: 0.5 },
    { name: "AMAA", fameMin: 30, blockbustersMin: 4, fameRewardWin: 3, moneyRewardWin: 10000, fameRewardNom: 0.75 },
    { name: "TIFF", fameMin: 40, blockbustersMin: 5, fameRewardWin: 4, moneyRewardWin: 20000, fameRewardNom: 1 },
    { name: "Emmys", fameMin: 50, blockbustersMin: 6, fameRewardWin: 5, moneyRewardWin: 50000, fameRewardNom: 1.5 },
    { name: "Oscars", fameMin: 60, blockbustersMin: 8, fameRewardWin: 6, moneyRewardWin: 75000, fameRewardNom: 2 }
  ];

  let eligibleAwards = awards.filter(award => fame >= award.fameMin && blockbusters >= award.blockbustersMin);
  if (eligibleAwards.length === 0) {
    if (fame >= 50) {
      await showInfoModal("😕 Your fame is high, but you need more blockbuster roles to be invited to award shows.");
      fame = Math.max(fame - 0.5, 1);
    }
    return;
  }

  const award = eligibleAwards[Math.floor(Math.random() * eligibleAwards.length)];
  let invited = await showModal(`🎉 You've been invited to the ${award.name}! Attend?`);
  if (!invited) {
    await showInfoModal("🙅 You skipped the award show.");
    return;
  }

  let nomChance = Math.min((fame - award.fameMin) * 0.02 + blockbusters * 0.05, 0.7);
  if (Math.random() < nomChance) {
    let nominated = await showModal(`🏆 You're nominated for Best Actor at the ${award.name}! Accept nomination?`);
    if (nominated) {
      // Generate 3-5 competing nominees
      const numCompetitors = Math.floor(Math.random() * 3) + 3;
      const competitors = Array.from({ length: numCompetitors }, () => ({
        name: ["Chris Hemsworth", "Viola Davis", "Leonardo DiCaprio", "Lupita Nyong'o", "Ryan Gosling", "Ayo Edebiri", "Tom Hanks", "Angela Bassett"][Math.floor(Math.random() * 8)],
        fame: Math.floor(award.fameMin + Math.random() * (award.fameMin * 0.5))
      }));
      competitors.push({ name: document.getElementById("nameDisplay").textContent.split(" (")[0], fame: fame });

      // Calculate win probability based on relative fame and skill
      const totalFame = competitors.reduce((sum, c) => sum + c.fame, 0);
      let winChance = Math.min((fame + practiceXP * 0.5) / (totalFame + practiceXP * 0.5) * 0.6, 0.5);
      const winner = Math.random() < winChance ? competitors[competitors.length - 1] : competitors[Math.floor(Math.random() * (competitors.length - 1))];

      if (winner.name === competitors[competitors.length - 1].name) {
        let won = await showModal(`🎉 You won Best Actor at the ${award.name}! Accept? (+${award.fameRewardWin} Fame, +${currencySymbol}${award.moneyRewardWin})`);
        if (won) {
          fame += award.fameRewardWin;
          money += award.moneyRewardWin;
          await showInfoModal(`🎉 You won Best Actor at the ${award.name}! +${award.fameRewardWin} Fame, +${currencySymbol}${award.moneyRewardWin}`);
          await generateFollowerReaction(true, true);
        } else {
          fame += 0.25;
          await showInfoModal(`🙅 You declined the award. +0.25 Fame`);
        }
      } else {
        fame += award.fameRewardNom;
        await showInfoModal(`😕 You didn't win at the ${award.name}. ${winner.name} (Fame: ${winner.fame}) won Best Actor. Nomination boosts your fame! +${award.fameRewardNom} Fame`);
        await generateFollowerReaction(true);
      }
    } else {
      await showInfoModal(`🙅 You declined the nomination.`);
    }
  } else {
    await showInfoModal(`😕 You attended the ${award.name} but weren't nominated this time.`);
  }
  fame = Math.floor(fame || 1);
  updateStats();
  updateWeekChoices();
  updateLifestyleButtons();
  saveGame();
}

    function updateStats() {
  document.getElementById("money").textContent = formatMoney(money || getStartingMoney(currencySymbol));
  document.getElementById("fame").textContent = (fame || 1).toFixed(2); // Show fame with 2 decimal places
  document.getElementById("followers").textContent = followers || 10;
  document.getElementById("skill").textContent = skill || "Beginner";
  document.getElementById("energy").textContent = energy || 100;
  document.getElementById("currencySymbol").textContent = currencySymbol || "$";
  document.getElementById("blockbusters").textContent = blockbusters || 0;
  const scriptsElement = document.getElementById("scripts");
  scriptsElement.textContent = scripts || 0;
  if (scripts > 0 || videoLibrary.length > 0) {
    const genreSummary = scriptQualities.map(s => `${s.quality} (${s.genres.join(", ") || "General"})`).join("; ");
    const videoSummary = videoLibrary.map(v => {
      const titleText = v.type === "Series Episode"
        ? `"${v.title}" (Episode ${v.episodeNumber} of "${v.seriesTitle}")`
        : `"${v.title}" (${v.type})`;
      return `${titleText} (${v.quality}, ${v.duration} min, ${v.genres.join(", ")}, ${v.isReleased ? "Released" : v.releaseWeek === 0 ? "In Library" : `Scheduled Y${v.releaseYear} W${v.releaseWeek}`}, ~${(v.expectedViews || 0).toLocaleString()} views)`;
    }).join("; ");
    scriptsElement.parentElement.title = `Scripts: ${genreSummary}${genreSummary && videoSummary ? "; " : ""}${videoSummary ? `Videos: ${videoSummary}` : ""}`;
  } else {
    scriptsElement.parentElement.title = "";
  }
  document.getElementById("ageDisplay").textContent = age || 17;
  document.getElementById("weekNum").textContent = `Year ${year || 1}, Week ${week || 1}`;

  const marriageStatus = document.getElementById("marriageStatus");
  if (marriageStatus) {
    marriageStatus.textContent = isMarried ? `💍 Married to ${spouseName}` : "💍 Single";
  }

  if (!isTikTokMonetized && followers >= 10000) {
    isTikTokMonetized = true;
    tiktokIncome = convertCurrency(Math.min(20 + Math.floor(followers * 0.03 / 1000), 300));
    tiktokMonetizationWeeks = 12;
    showInfoModal(`🎉 Your TikTok account is now monetized through the Creator Fund! You'll earn ${currencySymbol}${formatMoney(tiktokIncome)}/week from posts and additional revenue from short film views for ${tiktokMonetizationWeeks} weeks. Keep 10,000+ followers to maintain monetization.`);
  } else if (isTikTokMonetized && tiktokMonetizationWeeks === 0 && followers >= 10000) {
    tiktokIncome = convertCurrency(Math.min(20 + Math.floor(followers * 0.03 / 1000), 300));
    tiktokMonetizationWeeks = 12;
    showInfoModal(`📱 Your TikTok Creator Fund monetization has been renewed! You'll earn ${currencySymbol}${formatMoney(tiktokIncome)}/week from posts and additional revenue from short film views for ${tiktokMonetizationWeeks} weeks.`);
  } else if (isTikTokMonetized && followers < 10000) {
    isTikTokMonetized = false;
    tiktokIncome = 0;
    tiktokMonetizationWeeks = 0;
    showInfoModal(`😕 Your TikTok account is no longer monetized due to having fewer than 10,000 followers. Reach 10,000 followers to monetize again.`);
  }

  updateWeekChoices();
}

    function checkEnergy() {
  const minActionEnergy = 15;
  if (energy < minActionEnergy) {
    document.querySelectorAll(".choice-btn:not([onclick^='buyLifestyleItem'])").forEach(btn => btn.disabled = true);
  } else {
    enableButtons();
  }
  updateWeekChoices(); // Update action buttons
  updateLifestyleButtons();
}

    function disableButtons() {
      document.querySelectorAll(".choice-btn:not([onclick^='buyLifestyleItem'])").forEach(btn => btn.disabled = true);
    }

    function enableButtons() {
  document.querySelectorAll(".choice-btn:not([onclick^='buyLifestyleItem'])").forEach(btn => {
    // Only enable buttons for actions that don't have specific availability checks
    if (!["writeScriptBtn", "blockbusterBtn", "aListPartyBtn", "voiceActBtn", "endorsementBtn", "networkingBtn", "merchLineBtn", "produceMovieBtn"].includes(btn.id)) {
      btn.disabled = false;
    }
  });
  updateWeekChoices(); // Handle specific action buttons
}

    function resetGame() {
      localStorage.removeItem("actorSimSave");
      location.reload();
    }
    
window.onload = () => {
  if (localStorage.getItem("actorSimSave")) {
    if (loadGame()) {
      document.getElementById("game").style.display = "block";
      document.getElementById("profileForm").style.display = "none";
    } else {
      document.getElementById("profileForm").style.display = "block";
      document.getElementById("game").style.display = "none";
      money = getStartingMoney(currencySymbol);
      console.log("Starting new game due to load failure.");
    }
  } else {
    document.getElementById("profileForm").style.display = "block";
    document.getElementById("game").style.display = "none";
    money = getStartingMoney(currencySymbol);
    console.log("Starting new game.");
  }
};
    
  </script>
</body>
</html>
